# Unit Validation Rules

Regras de validação aplicadas a entity Unit (unidade habitacional) garantindo integridade de dados espaciais completude de informações cadastrais consistência de relacionamentos e compliance com requisitos técnicos e legais de regularização fundiária estabelecendo qualidade mínima necessária para aprovação e avanço no workflow de legitimação. Validação de identificação estabelece que code deve ser único dentro de Community impedindo duplicação de código identificador (query verifica existência de Unit com mesmo code e community_id rejeitando criação se encontrado mas permitindo mesmo code em Communities diferentes), code quando não fornecido pelo usuário deve ser gerado automaticamente pelo sistema usando sequência numérica ou padrão configurável (exemplo UH-YYYY-NNNN onde YYYY é ano e NNNN é sequencial) garantindo unicidade sem depender de input manual, community_id é obrigatório vinculando Unit a Community pai sem o qual Unit é órfã e inválida, e tenant_id é obrigatório e deve coincidir com tenant_id de Community pai garantindo isolamento multi-tenant correto. Validação de dados geográficos requer geometry quando preenchido deve ser polígono válido com mínimo 3 vértices formando área fechada (primeiro e último vértice coincidem) sem auto-interseções ou geometrias degeneradas, coordenadas de vértices devem estar dentro de bounds geograficamente plausíveis (tipicamente bounds do Brasil ou região específica de tenant configurável) rejeitando coordenadas manifestamente inválidas (latitude >90 ou longitude >180), geometry se preenchido deve estar contido geograficamente dentro de Community.geometry quando Community tem boundary definido garantindo que Units não extrapolam limites de assentamento (validação executada via operação espacial ST_Within ou similar), area_sqm deve ser maior que zero e menor que limite máximo configurável (exemplo 10000m² ou 1 hectare para áreas urbanas) prevenindo cadastro de áreas irrealisticamente grandes ou negativas indicando erro de cálculo ou entrada, area_sqm calculado de geometry deve ser consistente com area_declared se ambos preenchidos alertando se divergência excede threshold (exemplo 10% de diferença) indicando possível erro de medição ou digitação, e perimeter_m quando calculado de geometry deve ser plausível em relação a área (exemplo perímetro não pode ser menor que 4*sqrt(area) que seria perímetro de quadrado com mesma área) detectando geometrias anômalas. Validação de relacionamentos obrigatórios estabelece que ao menos um UnitHolder deve existir vinculando Unit a Holder antes de Unit poder transicionar para status IN_REVIEW APPROVED ou iniciar LegitimationRequest garantindo identificação de titular, ao menos uma foto (Document tipo PHOTO_FRONT) deve estar anexada antes de aprovação comprovando existência física de imóvel exceto se has_improvements é false indicando terreno vazio sem edificação para fotografar, Block e Plot quando vinculados (block_id plot_id preenchidos) devem existir e pertencer a mesma Community da Unit garantindo consistência de hierarquia geográfica, e created_by deve referenciar Account válido e ativo rastreando responsável por criação. Validação de campos obrigatórios exige address ou ao menos address.logradouro e address.municipio preenchidos permitindo localização básica de imóvel mesmo se endereço completo não disponível, unit_type deve ser valor válido de enum (RESIDENTIAL COMMERCIAL MIXED INSTITUTIONAL) descrevendo uso primário de imóvel, status deve ser valor válido de UnitStatus enum e estar em estado permitido conforme lifecycle (não pode criar Unit diretamente em status APPROVED deve iniciar em DRAFT), occupancy_type descrevendo natureza de ocupação (OWNER_OCCUPIED RENTED VACANT) é recomendado mas não obrigatório exceto para modalidades específicas de legitimação, e has_improvements booleano é obrigatório indicando presença ou ausência de benfeitorias edificadas orientando análises posteriores. Validação de limites de área conforme modalidade de REURB quando Unit está vinculada a LegitimationRequest verifica area_sqm ≤250m² se modality é REURB_S (interesse social) conforme limite legal Lei 13465/2017 rejeitando áreas maiores que desqualificam beneficiário, area_sqm ≤500m² se modality é REURB_E (interesse específico) conforme limite legal que varia por município mas tipicamente até 500m², e alertas são gerados se área se aproxima de limites (exemplo >240m² para REURB-S) orientando analista a verificar medição com atenção redobrada. Validação de sobreposição espacial detecta Units cujas geometrias sobrepõem indicando potencial conflito de propriedade executando query espacial (ST_Intersects ou similar) buscando outras Units na mesma Community com geometry interseccionando, calcula área de sobreposição (ST_Intersection) classificando severidade (overlap <5% pode ser tolerável por imprecisão de medição overlap >20% indica conflito real), exibe alerta ao analista listando Units conflitantes permitindo investigação de qual cadastro está correto ou se ambos são válidos com limite compartilhado que precisa ajuste, e permite override de validação com justificativa registrada em Annotation quando sobreposição é intencional (condomínio vertical unidades autônomas sobrepostas verticalmente sem conflito horizontal). Validação de qualidade de dados verifica campos opcionais mas recomendados como number_of_rooms number_of_bathrooms construction_type melhorando riqueza de cadastro e utilidade para planejamento urbano, detecta inconsistências lógicas como number_of_rooms zero ou negativo has_improvements true mas construction_type vazio ou area_sqm muito pequena (<20m²) para number_of_rooms declarado (exemplo 5 quartos em 25m² é implausível), e sugere correções baseadas em padrões detectados ou dados de Units similares (exemplo se maioria de Units em Community tem construction_type ALVENARIA sugerir mesmo tipo para Unit sem tipo definido). Validação de documentação necessária para legitimação quando Unit vai iniciar LegitimationRequest verifica presença de Documents obrigatórios variáveis conforme modalidade (REURB-S requer fotos declaração de hipossuficiência comprovante residência enquanto REURB-E adiciona certidões negativas comprovante renda), valida que DescriptiveMemorial e LegitimationPlan estão vinculados a Unit via foreign keys e têm status approved garantindo documentação técnica está pronta, e confirma que todos Holders vinculados têm documentação pessoal completa (CPF RG) bloqueando início de processo se documentação incompleta. Validação em status transitions implementa regras de quais mudanças de status são permitidas baseadas em estado atual e role de usuário conforme definido em unit-status-transitions.md (exemplo DRAFT pode ir para PENDING_ANALYSIS por qualquer usuário mas PENDING_ANALYSIS para APPROVED requer MANAGER), verifica pré-condições para cada transição (exemplo não pode aprovar Unit sem Holder vinculado ou sem fotos), e registra audit trail em AuditLog capturando old status new status account responsável e timestamp permitindo rastreabilidade completa de lifecycle. Validação de offline sync em aplicativo mobile executa subset de validações executáveis sem conectividade como geometry é polígono válido area maior que zero code preenchido permitindo feedback imediato ao técnico de campo, marca Units com flag pending_full_validation indicando validações pendentes (unicidade de code sobreposição espacial consistência com Community) que serão executadas durante sincronização, e servidor executa validações completas durante push rejeitando Units que falham em validações críticas (code duplicado sobreposição >50%) ou marcando como REQUIRES_CHANGES se validações não críticas falham (documentação incompleta área próxima de limite) permitindo correção posterior. Erros de validação geram mensagens user-friendly orientando sobre problema e ação corretiva (exemplo Geometria inválida polígono não fecha verifique último vértice ou Área excede limite REURB-S (250m²) considerar divisão ou REURB-E) facilitando resolução, são agregados em relatório de validação quando validação de múltiplas Units em lote permitindo analista priorizar correções, e bloqueiam transições de status críticas (aprovação início de legitimação) mas permitem salvar Unit em draft ou pending para correção futura não perdendo trabalho realizado.

**Relacionado:**
- Entities: Unit, Community, UnitHolder, Holder, Block, Plot, Document, LegitimationRequest
- Value Objects: UnitStatus, Address, GeoPoint
- Business Rules: unit-status-transitions.md, holder-validation.md

---

**Última atualização:** 2025-01-05
**Status do arquivo**: Pronto
