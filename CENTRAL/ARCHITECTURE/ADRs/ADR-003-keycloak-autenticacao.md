# ADR-003: Escolha do Keycloak para Autenticação e Autorização

Decisão arquitetural escolhendo Keycloak como Identity Provider (IdP) e solução de Single Sign-On (SSO) para todo ecossistema CARF justificada por implementação completa de padrões OAuth2 e OpenID Connect (OIDC) eliminando necessidade de desenvolver autenticação customizada propensa a vulnerabilidades críticas de segurança, suporte nativo a múltiplos Identity Providers externos (Google Microsoft GitHub Facebook SAML-based corporate IdPs) permitindo login social e integração com sistemas de autenticação existentes de prefeituras através de federation sem migração de usuários ou sincronização manual de senhas, arquitetura multi-realm isolando completamente dados de autenticação entre diferentes tenants (prefeituras) no mesmo servidor Keycloak garantindo que comprometimento de um realm não afeta outros alinhado com requisitos de segurança multi-tenant RNF-013, Role-Based Access Control (RBAC) granular com suporte a grupos hierárquicos permitindo modelagem de estrutura organizacional complexa de prefeituras (Secretarias Departamentos Equipes) e atribuição de permissões por grupo propagando automaticamente para membros sem necessidade de atribuição individual, token management robusto com refresh tokens de longa duração (7 dias) e access tokens de curta duração (15 minutos) balanceando segurança contra vazamento com user experience sem re-autenticação frequente conforme especificado em RF-004, session management centralizado permitindo logout global propagando invalidação de sessão para todas aplicações (GEOAPI GEOWEB REURBCAD GEOGIS) simultaneamente através de backchannel logout evitando sessões órfãs após logout conforme RF-006, MFA (Multi-Factor Authentication) suportando TOTP (Time-based One-Time Password via Google Authenticator) e SMS para usuários privilegiados (SUPER_ADMIN ADMIN) aumentando segurança de contas críticas conforme políticas de segurança SECURITY/POLICIES/, customização completa de UI de login permitindo white-labeling com logo e cores de cada prefeitura mantendo experiência branded sem desenvolver telas de autenticação customizadas, auditoria integrada registrando todos eventos de autenticação (login logout falhas MFA password reset) em logs estruturados facilitando compliance LGPD e investigação de incidentes de segurança conforme RF-016, user federation permitindo sincronização bidirecional com Active Directory LDAP de prefeituras grandes mantendo fonte única de usuários corporativos sem duplicação manual, password policies configuráveis por realm (complexidade expiração histórico) permitindo adaptar requisitos de senha a políticas específicas de cada prefeitura, e deployment flexível suportando standalone mode para desenvolvimento e clustered mode com PostgreSQL backend para produção garantindo alta disponibilidade e session replication entre nós.

Keycloak 23.x especificamente adiciona Admin REST API v2 com melhor performance e documentação OpenAPI facilitando automação de provisionamento de realms e usuários via Infrastructure as Code, Passkeys/WebAuthn support preparando sistema para autenticação sem senha futura reduzindo fricção de login, e OAuth2 Device Authorization Grant permitindo autenticação em dispositivos sem browser (impressoras tablets legados) através de código de ativação.

Alternativas consideradas incluem Auth0 (rejeitado por custo elevado em escala com milhares de usuários ativos mensais tornando inviável para prefeituras pequenas e vendor lock-in com APIs proprietárias dificultando migração futura), AWS Cognito (rejeitado por lock-in AWS e limitações de customização de UI exigindo desenvolvimento frontend customizado além de ausência de user federation com LDAP corporativo), Firebase Authentication (rejeitado por ser mobile-first com suporte limitado a web e ausência de RBAC granular exigindo implementação manual de controle de acesso), Ory Hydra/Kratos (rejeitado por maturidade inferior a Keycloak e ausência de Admin UI exigindo desenvolvimento de console administrativo customizado aumentando custo), e implementação customizada com IdentityServer4 (rejeitado por overhead de manutenção desenvolvimento e testes de funcionalidades já resolvidas por Keycloak além de risco de vulnerabilidades em código proprietário).

Consequências positivas incluem time-to-market acelerado eliminando 3-6 meses de desenvolvimento de sistema de autenticação completo, segurança robusta com software auditado e testado por comunidade global reduzindo risco de vulnerabilidades críticas, compliance facilitado com LGPD através de auditoria e controle de acesso granular, flexibilidade de integração com IdPs corporativos de prefeituras grandes permitindo SSO com sistemas legados, SSO transparente entre aplicações melhorando experiência do usuário eliminando múltiplos logins, e custo zero de licensing sendo open-source sob licença Apache 2.0. Consequências negativas incluem complexidade operacional exigindo expertise em administração Keycloak e troubleshooting de problemas de autenticação, overhead de infraestrutura rodando servidor adicional (Keycloak + PostgreSQL próprio) consumindo ~2GB RAM e exigindo backup separado, latência adicional de ~50-100ms em cada requisição para validação de tokens JWT via JWKS endpoint (mitigado com cache local de chaves públicas), curva de aprendizado de conceitos OAuth2/OIDC para desenvolvedores não familiarizados com flows de autenticação modernos, e dependência de disponibilidade de Keycloak para autenticação tornando-o single point of failure parcial (mitigado com clustering em produção).

Configuração específica escolhida utiliza Keycloak 23.0.3 (última versão estável em 2024-Q3) com PostgreSQL 16 dedicado como backend evitando conflitos com database principal da aplicação, realm por tenant com isolation completo entre prefeituras, access token lifetime de 15 minutos balanceando segurança com frequência de refresh, refresh token lifetime de 7 dias permitindo remember me sem re-login semanal, session idle timeout de 30 minutos detectando usuários inativos, e bruteforce protection com lockout temporário após 5 falhas consecutivas de login protegendo contra ataques de força bruta.

Status da decisão é aprovado e implementado desde início do projeto em 2024-Q3, com revisão prevista apenas se Keycloak introduzir breaking changes em major version futura ou se surgir solução open-source superior (improvável dado domínio atual de Keycloak em mercado enterprise).

## Implementação

Decisão implementada através do projeto [KEYCLOAK](../../../PROJECTS/KEYCLOAK/DOCS/README.md) hospedando servidor Keycloak com realms customizados por tenant implementando multi-tenancy model com isolamento por município, integração client-side via [@carf/tscore KeycloakClient](../../../PROJECTS/LIB/TS/TSCORE/DOCS/CONCEPTS/02-authentication.md) utilizado nos frontends [GEOWEB](../../../PROJECTS/GEOWEB/DOCS/README.md), [REURBCAD](../../../PROJECTS/REURBCAD/DOCS/README.md) e [ADMIN](../../../PROJECTS/ADMIN/DOCS/ARCHITECTURE/04-integration.md) executando OAuth2 + PKCE flow para obtenção de tokens JWT, validação server-side de tokens JWT no backend [GEOAPI](../../../PROJECTS/GEOAPI/DOCS/ARCHITECTURE/02-admin-security.md) via middleware ASP.NET Core verificando assinatura RSA com public key do realm, e gestão de usuários via Keycloak Admin API REST permitindo CRUD de users roles e attributes.

---

**Data:** 2024-09-15
**Status:** Aprovado e Implementado
**Decisor:** Equipe de Arquitetura + Segurança
**Última revisão:** 2025-01-05
