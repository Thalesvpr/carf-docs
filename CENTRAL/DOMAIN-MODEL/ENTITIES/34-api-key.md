# ApiKey (Chave de API para Integrações)

Entidade representando chave de API usada para autenticação de integrações externas plugins GIS scripts de automação e sistemas terceiros permitindo acesso programático à API REST sem necessidade de autenticação OAuth2 interativa de usuário humano. Campos conceituais incluem identificador único global, tenant_id vinculando chave a instituição específica garantindo isolamento multi-tenant onde chave criada por tenant A não pode acessar dados de tenant B, key_value valor da chave formatado conforme ApiKeyValue value object (geoapi_sk_{32_random_chars}) usado pelo cliente para autenticar requisições HTTP, name descrição amigável identificando propósito ou sistema que usa chave (Plugin QGIS Topografia, Script sincronização noturna, Integração sistema municipal) facilitando gerenciamento quando múltiplas chaves existem, permissions_scope JSON array de permissões granulares concedidas à chave especificando exatamente quais recursos e operações são permitidas (units:read, units:create, holders:read, reports:generate) implementando princípio de privilégio mínimo onde chave só pode fazer o estritamente necessário, active booleano indicando se chave está ativa e pode autenticar requisições (true permite uso, false revoga acesso sem deletar registro preservando histórico), created_by referenciando Account do administrador que criou chave estabelecendo responsabilidade e rastreabilidade de quem emitiu credenciais, created_at timestamp de criação da chave, expires_at timestamp opcional de expiração automática após o qual chave se torna inválida (null para chaves sem expiração, timestamp futuro para chaves temporárias ou de teste), last_used_at timestamp opcional da última requisição autenticada usando esta chave atualizado em cada API call bem-sucedida permitindo identificação de chaves não utilizadas que podem ser revogadas, e usage_count contador de número total de requisições autenticadas com esta chave fornecendo métrica de intensidade de uso. Relacionamentos incluem pertence a Tenant (N:1 isolamento multi-tenant), foi criada por Account administrador (N:1 rastreabilidade de emissão), e é usada em requisições auditadas via AuditLog (1:N indiretamente correlacionando ações com chave que as executou). Regras de negócio estabelecem que key_value deve ser gerado usando ApiKeyValue value object garantindo formato padronizado e segurança criptográfica, chave completa (plaintext geoapi_sk_abc123...) é exibida ao usuário apenas uma vez imediatamente após criação com aviso explícito para copiar e guardar em local seguro pois não poderá ser visualizada novamente (sistema armazena apenas hash criptográfico), armazenamento em banco de dados salva hash bcrypt ou argon2 do key_value ao invés de plaintext protegendo chaves mesmo se banco for comprometido, permissions_scope deve ser array não vazio validando que ao menos uma permissão foi concedida (chave sem permissões é inútil e provavelmente erro de configuração), active=false revoga chave imediatamente fazendo autenticação falhar sem deletar registro (permite reativação futura se revogação foi acidental), expires_at se presente deve ser timestamp futuro (não pode criar chave já expirada), e last_used_at atualização é best-effort assíncrona para não impactar performance de requisições autenticadas (pode ter atraso de alguns segundos). Workflow típico inicia quando administrador ADMIN ou MANAGER cria nova ApiKey via interface web especificando name descritivo e selecionando permissions_scope de lista de permissões disponíveis, sistema gera key_value usando ApiKeyValue.generate() produzindo chave aleatória criptograficamente segura, exibe chave completa em modal de sucesso com botão "Copiar para clipboard" e aviso "Esta chave não será exibida novamente, guarde em local seguro", administrador copia chave e armazena em arquivo de configuração do sistema integrado ou gerenciador de senhas, sistema calcula hash de key_value e armazena em ApiKey.key_value_hash (campo separado ou reutilizando key_value como hash dependendo de implementação), marca ApiKey.active=true liberando para uso, cliente externo (plugin QGIS, script Python, sistema municipal) inclui chave em requisições HTTP via header (Authorization: Bearer geoapi_sk_abc123...) ou query parameter (?api_key=geoapi_sk_abc123...), servidor extrai chave do request calcula hash e consulta ApiKey ativa com hash correspondente, valida que ApiKey.active=true e expires_at não foi ultrapassado, extrai tenant_id e permissions_scope da chave autenticada, verifica que endpoint requisitado está incluído em permissions_scope (requisição para GET /api/units requer units:read em scope), permite requisição se permissão adequada existe ou rejeita com HTTP 403 Forbidden se permissão falta, atualiza last_used_at e incrementa usage_count assincronamente sem bloquear response, e retorna dados isolados por tenant_id da chave garantindo acesso apenas a recursos do tenant proprietário. Administrador pode revogar chave a qualquer momento marcando active=false invalidando imediatamente todas requisições subsequentes usando aquela chave, pode editar permissions_scope de chave existente expandindo ou restringindo acessos conforme necessidade evolui (começar com units:read depois adicionar units:create quando integração amadurece e é confiável), e pode visualizar dashboard de chaves listando todas chaves do tenant com indicadores de uso (última utilização, total de requisições, permissões concedidas) facilitando auditoria e identificação de chaves esquecidas ou suspeitas. Sistema implementa rate limiting mais rigoroso para requisições via API key comparado com usuários OAuth2 humanos (limite configurável por chave ou globalmente) prevenindo abuso de credenciais comprometidas ou scripts mal comportados que fazem requisições excessivas, pode detectar padrões de uso anômalo comparando com baseline histórico de chave (chave que normalmente faz 100 req/dia subitamente faz 10000 req/dia pode indicar comprometimento) disparando alerta automático para administrador, e gera relatório de uso de API keys agrupando por chave e endpoint revelando quais integrações consomem mais recursos permitindo otimização ou cobrança proporcional se sistema for SaaS. Rotação automática de chaves pode alertar administrador quando chave tem mais de 90 dias sem rotação sugerindo criação de nova chave e revogação da antiga reduzindo janela de exposição se chave foi comprometida sem conhecimento, chaves expiradas automaticamente (expires_at ultrapassado) são marcadas active=false por job agendado sem necessidade de intervenção manual, e histórico completo de criação uso e revogação é mantido em AuditLog permitindo investigação forense se incidente de segurança envolvendo API key for detectado.

**Implementações por projeto:**
- Backend .NET: `PROJECTS/GEOAPI/LAYERS/DOMAIN/ENTITIES/34-api-key.md`
- Frontend React: `PROJECTS/GEOWEB/MODELS/ENTITIES/api-key.ts`
- Mobile React Native: `PROJECTS/REURBCAD/MODELS/ENTITIES/api-key.ts` (não aplicável)
- Plugin GIS Python: `PROJECTS/GEOGIS/MODELS/api_key.py`

---

**Última atualização:** 2025-01-05
