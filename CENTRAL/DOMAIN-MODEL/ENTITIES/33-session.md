# Session (Sessão de Usuário Autenticado)

Entidade representando sessão ativa de usuário autenticado no sistema rastreando token de acesso metadados de dispositivo e navegador e timestamp de criação e expiração permitindo gerenciamento de sessões ativas logout forçado e auditoria de acessos. Campos conceituais incluem identificador único global, account_id referenciando usuário proprietário da sessão estabelecendo vínculo entre credenciais autenticadas e sessão ativa, token_hash hash criptográfico do token de sessão usado para autenticação de requisições (bcrypt ou sha256 do token JWT ou opaco) armazenado em formato hasheado ao invés de plaintext garantindo que comprometimento de banco de dados não expõe tokens válidos, ip_address endereço IP do cliente que criou sessão usado para auditoria de localização geográfica aproximada e detecção de acessos anômalos (login de localização inesperada), user_agent string de identificação do navegador ou aplicativo cliente contendo informação sobre sistema operacional versão de navegador e tipo de dispositivo (Mozilla/5.0 Windows NT 10.0 Chrome/120.0, App Mobile Android 13 versão 2.5.0) facilitando identificação de sessões por dispositivo, created_at timestamp de criação da sessão marcando momento de autenticação bem-sucedida, expires_at timestamp de expiração calculado automaticamente baseado em política de tempo de vida de sessão (15 minutos para access token, 7 dias para refresh token, 30 dias para remember-me) após o qual sessão se torna inválida requerendo reautenticação, last_activity_at timestamp de última requisição autenticada usando esta sessão atualizado em cada API call permitindo detecção de sessões inativas e implementação de sliding expiration, revoked_at timestamp opcional indicando quando sessão foi revogada manualmente (logout explícito, logout forçado por admin, detecção de atividade suspeita) invalidando token antes de expiração natural, e revocation_reason enum opcional explicando motivo de revogação (USER_LOGOUT usuário clicou logout voluntariamente, ADMIN_FORCED administrador forçou logout remotamente, SECURITY_INCIDENT sessão revogada por detecção de atividade suspeita, TOKEN_REFRESH sessão antiga revogada ao gerar novo token via refresh). Relacionamentos incluem pertence a Account usuário autenticado (N:1 usuário pode ter múltiplas sessões simultâneas em diferentes dispositivos), pode ter SessionActivity logs de atividades realizadas durante sessão (1:N opcional rastreando ações importantes executadas), e é referenciada por AuditLog entries vinculando ações auditadas a sessões específicas (N:N indiretamente via account_id e timestamp correlation). Regras de negócio estabelecem que cada requisição autenticada à API deve incluir token válido em header Authorization (Bearer token_value) ou cookie httpOnly, servidor extrai token do request calcula hash e consulta Session ativa verificando que token_hash corresponde account_id está ativo e expires_at não foi ultrapassado, sessão expirada (current_time > expires_at) é rejeitada retornando HTTP 401 Unauthorized forçando cliente a renovar token via refresh endpoint ou reautenticar, sessão revogada (revoked_at preenchido) é rejeitada mesmo se ainda não expirou naturalmente implementando logout forçado efetivo, last_activity_at é atualizado a cada requisição autenticada bem-sucedida permitindo implementação de sliding expiration onde expiração é estendida automaticamente enquanto sessão está ativa, e usuário pode ter múltiplas sessões simultâneas (desktop browser, mobile app, tablet) cada uma rastreada independentemente permitindo logout seletivo por dispositivo ou logout global revogando todas sessões de uma vez. Workflow típico inicia quando usuário autentica com sucesso via OAuth2 Keycloak recebendo access token e refresh token, sistema cria Session armazenando hash do access token junto com metadados de client (IP user-agent), define expires_at baseado em tempo de vida configurado do access token (tipicamente 15 minutos), cliente inclui access token em header de cada requisição subsequente à API, servidor valida token consultando Session verificando hash e expiração, atualiza last_activity_at registrando atividade recente, quando access token expira (15 minutos) cliente automaticamente chama endpoint de refresh apresentando refresh token válido, sistema valida refresh token revoga Session antiga criando nova Session com novo access token retornando para cliente, cliente continua usando novo access token até próxima expiração repetindo ciclo, e quando usuário clica logout explícito ou administrador força logout sistema marca Session.revoked_at invalidando imediatamente token sem aguardar expiração natural. Sistema pode implementar detecção de anomalias comparando ip_address e user_agent de requisições com valores armazenados em Session alertando se mudança drástica é detectada (IP mudou de Brasil para China, user_agent mudou de Chrome desktop para Safari mobile) sugerindo possível roubo de token, rate limiting de tentativas de autenticação por IP bloqueando temporariamente endereços que tentam autenticar repetidamente com credenciais inválidas prevenindo brute force attacks, e dashboard de sessões ativas permitindo usuário visualizar lista de dispositivos conectados (Desktop Chrome Windows última atividade 2 min atrás, Mobile App Android última atividade 1 hora atrás) com botão para revogar sessões individualmente ou todas de uma vez protegendo contra acesso não autorizado se dispositivo foi perdido ou roubado. Limpeza automática de sessões expiradas executa job periódico (diariamente) deletando Sessions onde expires_at < current_time - 30 days mantendo banco de dados enxuto enquanto preserva sessões recentes para auditoria de curto prazo, sessões revogadas são mantidas por período de retenção configurável (90 dias) para investigação de incidentes de segurança antes de serem deletadas permanentemente, e exportação de logs de sessões para sistema de SIEM externo permite correlação com eventos de segurança de outras fontes facilitando detecção de padrões de ataque distribuído ou comprometimento de contas.

**Módulos:** GEOAPI (backend), GEOGIS (autenticação plugin)

---

**Última atualização:** 2026-01-10
**Status do arquivo**: Pronto
