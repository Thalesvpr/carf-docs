# AuditLog (Log de Auditoria)

Entidade imutável representando registro de auditoria de operações CUD (Create Update Delete) no sistema rastreando quem modificou o que quando e de onde garantindo compliance e permitindo investigação de incidentes. Campos conceituais incluem identificador único global, tenant_id vinculando log ao tenant onde operação ocorreu, account_id referenciando usuário que executou ação, entity_type enum indicando tipo de entidade afetada (UNIT HOLDER COMMUNITY LEGITIMATION_REQUEST etc), entity_id identificador da entidade específica modificada, action enum especificando operação realizada (CREATE INSERT UPDATE DELETE APPROVE REJECT etc), old_values JSON contendo snapshot de valores antes da modificação (NULL para CREATE, objeto completo para UPDATE e DELETE), new_values JSON contendo snapshot de valores após modificação (objeto completo para CREATE e UPDATE, NULL para DELETE), ip_address endereço IP de origem da requisição para rastreamento geográfico e identificação de acessos suspeitos, user_agent string identificando browser ou app usado (útil para correlacionar problemas com versões específicas), timestamp data e hora exata da operação com precisão de milissegundos, e opcionalmente reason texto livre explicando motivo da ação quando aplicável (exemplo: DELETE de Unit pode ter reason "Duplicata identificada" ou REJECT de LegitimationRequest tem reason "Documentação incompleta"). Relacionamentos incluem pertence a um Tenant (N:1 para segregação de logs por cliente), executado por um Account (N:1 rastreando autor da ação), e referencia polimorficamente qualquer entidade via entity_type + entity_id permitindo reconstruir histórico completo de modificações de qualquer registro. Regras de negócio estabelecem que AuditLog é append-only imutável (registros nunca são atualizados ou deletados fisicamente garantindo integridade da trilha de auditoria), operações sensíveis como DELETE ou mudanças de status críticas (APPROVED REJECTED) são sempre auditadas mesmo se outras operações menores forem auditadas seletivamente, campos old_values e new_values podem omitir dados sensíveis (senhas hashes tokens) ou PII desnecessário (fotos completas) armazenando apenas metadados relevantes (photo_id changed, size, mime_type) reduzindo volume de armazenamento e protegendo privacidade, e retenção de logs segue política configurável por tenant (mínimo 5 anos conforme LGPD depois anonimização ou arquivamento em storage frio). Workflow típico de criação ocorre automaticamente via interceptor ou middleware capturando todas operações CUD no ORM ou camada de repositório, antes de salvar modificação sistema captura snapshot de estado atual da entidade (old_values), executa operação normalmente, captura snapshot pós-modificação (new_values), cria registro AuditLog com todos metadados incluindo account_id do usuário autenticado e ip_address extraído do contexto HTTP, e salva log em transação separada ou assíncrona para não impactar performance de operação principal. Consulta de audit trail exibe timeline cronológica de todas modificações de uma entidade mostrando quem mudou o que quando, diff visual comparando old_values e new_values destacando campos alterados facilita entendimento de mudanças, e filtros permitem buscar todas ações de usuário específico (investigar ações de ex-funcionário antes de desligamento) ou todas operações em período (atividade durante final de semana suspeito). Compliance LGPD utiliza audit logs para atender direito de portabilidade (gerar relatório completo de todas operações envolvendo dados de titular específico) e investigação de vazamento (rastrear quem acessou dados sensíveis em período suspeito), LGPD também exige que próprios logs sejam protegidos contra modificação não autorizada usando checksums ou blockchain para detecção de tampering. Sistema pode ter níveis de auditoria configuráveis onde modo MINIMAL audita apenas operações sensíveis (aprovações exclusões mudanças de permissão), modo STANDARD audita todas operações CUD, e modo VERBOSE audita até leituras (GET queries) útil para investigação forense mas custoso em volume de dados. Alertas automáticos podem ser configurados disparando notificação quando padrões suspeitos são detectados (mesmo IP tentando acessar múltiplos tenants, volume anormal de DELETEs, acessos fora de horário comercial), dashboards de segurança agregam métricas de audit logs mostrando usuários mais ativos, tipos de operações mais frequentes, e tendências ao longo do tempo.

**Implementações por projeto:**
- Backend .NET: `PROJECTS/GEOAPI/LAYERS/DOMAIN/ENTITIES/18-audit-log.md`
- Frontend React: `PROJECTS/GEOWEB/MODELS/ENTITIES/audit-log.ts` (somente leitura para exibição)
- Mobile React Native: `PROJECTS/REURBCAD/MODELS/ENTITIES/audit-log.ts` (não aplicável, auditoria é backend-only)
- Plugin GIS Python: `PROJECTS/GEOGIS/MODELS/audit_log.py` (somente leitura se necessário)

---

**Última atualização:** 2025-01-05
