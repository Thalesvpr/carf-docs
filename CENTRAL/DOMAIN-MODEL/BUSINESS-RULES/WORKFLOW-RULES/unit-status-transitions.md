# Unit Status Transitions

Regras governando transições válidas de status de Unit através de lifecycle desde criação inicial em campo até aprovação final estabelecendo state machine que controla quais mudanças de estado são permitidas baseadas em status atual role de usuário executing ação e pré-condições de negócio garantindo integridade de workflow e compliance com processo de validação cadastral. Status possíveis conforme UnitStatus value object incluem DRAFT representando Unit em edição inicial cadastrada em campo ou sistema mas não submetida para validação permitindo modificações livres, PENDING_ANALYSIS representando Unit submetida aguardando revisão por analista após técnico de campo marcar cadastro como completo, IN_REVIEW representando Unit sob análise ativa por analista que está validando dados corrigindo geometria e verificando completude, APPROVED representando Unit aprovada por analista ou gestor com dados validados e geometria corrigida pronta para uso em processos subsequentes como legitimação, REJECTED representando Unit rejeitada por não atender critérios técnicos ou legais (exemplo ocupação em área pública ou área de risco) finalizando lifecycle sem aprovação, e REQUIRES_CHANGES representando Unit devolvida para correção com lista de pendências identificadas por analista requerendo ação de técnico ou requerente antes de resubmissão. Transições permitidas de DRAFT estado inicial estabelecem DRAFT → PENDING_ANALYSIS executável por qualquer usuário autenticado (FIELD_AGENT ANALYST MANAGER ADMIN) marcando Unit como pronta para validação sem pré-condições obrigatórias além de campos mínimos (code community_id address básico), DRAFT → IN_REVIEW executável por ANALYST ou superior pulando fila de pendentes quando analista assume Unit diretamente útil para correções rápidas ou Units prioritárias, e DRAFT → DRAFT (permanecer) permitindo edições contínuas sem mudança de status até usuário decidir submeter. Transições permitidas de PENDING_ANALYSIS estabelecem PENDING_ANALYSIS → IN_REVIEW executável apenas por ANALYST MANAGER ou ADMIN iniciando análise formal com pré-condição que ao menos um Holder está vinculado garantindo identificação de titular, PENDING_ANALYSIS → DRAFT executável por qualquer usuário permitindo retorno para edição se erro foi detectado antes de análise iniciar (exemplo técnico percebe que cadastrou Unit errada), e PENDING_ANALYSIS → REJECTED executável por MANAGER ou ADMIN em casos excepcionais onde rejeição é óbvia sem necessidade de análise detalhada (exemplo duplicata clara ou ocupação manifestamente irregular) com justificativa obrigatória registrada em Annotation. Transições permitidas de IN_REVIEW estabelecem IN_REVIEW → APPROVED executável apenas por MANAGER ou superior requerendo aprovação explícita de gestor após análise de analista com pré-condições rigorosas incluindo ao menos um Holder vinculado ao menos uma foto anexada (exceto se has_improvements false), geometry válido e dentro de Community bounds se Community tem boundary, area_sqm dentro de limites plausíveis, e nenhum alerta crítico não resolvido (sobreposição >50% documentação obrigatória faltante), IN_REVIEW → REQUIRES_CHANGES executável por ANALYST ou superior devolvendo Unit para correção com lista de pendências registradas em Annotation ou campo notes da Unit orientando o que precisa ser corrigido, IN_REVIEW → REJECTED executável por MANAGER ou superior quando problemas insanáveis são identificados (ocupação em área non aedificandi imóvel demolido titular falecido sem herdeiros identificados) com justificativa obrigatória, e IN_REVIEW → PENDING_ANALYSIS executável por ANALYST permitindo retornar Unit para fila se análise não pode ser concluída no momento (exemplo aguardando informação externa). Transições permitidas de APPROVED estabelecem APPROVED → IN_REVIEW executável apenas por ADMIN ou superior permitindo reabertura de Unit aprovada em casos excepcionais (erro detectado após aprovação atualização de dados solicitada por titular) com justificativa obrigatória e criação de registro de auditoria detalhado rastreando motivo de reabertura account responsável e timestamp, APPROVED → APPROVED (permanecer) sendo estado estável que não requer transições exceto para correções excepcionais, e bloqueio de APPROVED → REJECTED direto exigindo passar por IN_REVIEW antes garantindo revisão cuidadosa antes de reverter aprovação já concedida. Transições permitidas de REJECTED estabelecem REJECTED → IN_REVIEW executável apenas por ADMIN permitindo reabertura de Unit rejeitada se decisão de rejeição foi revertida (exemplo área considerada pública foi reclassificada como passível de regularização titular apresentou documentação adicional não disponível anteriormente) com justificativa obrigatória e aprovação de superior hierárquico, e REJECTED → REJECTED (permanecer) sendo estado final em maioria de casos sem transições automáticas. Transições permitidas de REQUIRES_CHANGES estabelecem REQUIRES_CHANGES → DRAFT executável por FIELD_AGENT ou criador original da Unit permitindo edição para corrigir pendências listadas retornando para estado inicial de rascunho, REQUIRES_CHANGES → IN_REVIEW executável por ANALYST ou superior após verificar que correções foram realizadas retomando análise sem passar novamente por PENDING_ANALYSIS economizando etapa, e REQUIRES_CHANGES → PENDING_ANALYSIS executável por qualquer usuário resubmetendo Unit após correções para entrar novamente em fila de validação. Pré-condições globais para qualquer transição verificam que usuário tem permissão adequada conforme CommunityAuthorization (can_edit ou superior para Community da Unit) impedindo modificação de Units em Communities não autorizadas, Unit não está vinculada a LegitimationRequest em andamento com status que impede modificação (exemplo legitimação já aprovada ou certificado emitido congela Unit) protegendo integridade de processos formais, e version field de Unit coincide com versão atual no banco prevenindo conflitos de edição concorrente rejeitando transição se Unit foi modificada por outro usuário desde que foi carregada. Enforcement de transições implementado através de state machine no backend validando toda requisição de mudança de status verificando se transição solicitada é permitida de estado atual para estado desejado conforme regras definidas, checando role de Account executando ação comparando com roles permitidos para transição específica, validando pré-condições de negócio executando queries e verificações necessárias antes de permitir transição, rejeitando requisição com HTTP 400 Bad Request ou 403 Forbidden se transição não permitida incluindo mensagem de erro explicativa (exemplo Apenas MANAGER pode aprovar Unit ou Unit deve ter Holder vinculado antes de aprovação), e registrando transição bem-sucedida em AuditLog capturando status anterior status novo account responsável timestamp e justificativa se fornecida permitindo auditoria completa de lifecycle. Notificações automáticas são disparadas em transições específicas incluindo PENDING_ANALYSIS → IN_REVIEW notifica Account que criou Unit informando que análise iniciou, IN_REVIEW → REQUIRES_CHANGES notifica criador listando pendências identificadas e orientando correções, IN_REVIEW → APPROVED notifica criador e Holders vinculados (via email se disponível) informando aprovação e próximos passos possíveis (início de legitimação), e IN_REVIEW → REJECTED notifica criador com justificativa de rejeição e orientação sobre recursos ou alternativas. Dashboard e relatórios agregam Units por status permitindo gestores monitorar distribuição (exemplo 150 DRAFT 80 PENDING_ANALYSIS 30 IN_REVIEW 200 APPROVED) identificando gargalos no workflow, rastrear tempo médio em cada status detectando etapas lentas que requerem otimização ou alocação de mais recursos, e visualizar taxa de aprovação rejeição e necessidade de correções medindo qualidade de cadastros iniciais e efetividade de treinamento de equipe de campo.

**Relacionado:**
- Entities: Unit, Account, CommunityAuthorization, Annotation, AuditLog
- Value Objects: UnitStatus
- Business Rules: unit-validation.md
- Workflows: field-data-collection-workflow.md, analyst-validation-workflow.md

---

**Última atualização:** 2025-01-05
