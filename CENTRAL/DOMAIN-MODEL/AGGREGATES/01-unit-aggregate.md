# Unit Aggregate

Agregado de domínio tendo Unit como raiz controlando consistência transacional de unidade habitacional e suas entidades fortemente relacionadas seguindo padrão DDD de bounded consistency. Raiz do agregado é Unit entity que coordena todas mudanças garantindo invariantes de negócio, componentes internos incluem coleção de UnitHolder relacionamentos N:N com Holders contendo tipo de vínculo e percentual de propriedade, coleção de Documents anexos polimórficos vinculados à unidade, e coleção de Annotations observações da unidade. Limites do agregado estabelecem que apenas Unit pode adicionar ou remover UnitHolder garantindo que soma de percentuais de propriedade não excede 100%, apenas Unit pode adicionar Documents validando tipos permitidos e limites de tamanho, mudanças em entities dentro do agregado (como alterar tipo de UnitHolder) devem passar pela raiz Unit que valida e dispara eventos, e transação de persistência salva Unit e todos componentes atomicamente ou reverte tudo. Invariantes garantidas incluem Unit deve ter ao menos um Holder antes de status APPROVED validado ao tentar aprovar, soma de OwnershipPercentage de todos UnitHolder com tipo PROPRIETARIO não pode exceder 100%, Documents vinculados devem ter EntityType igual a UNIT e EntityId igual ao Unit.Id, e geometria se preenchida deve estar dentro ou próxima do perímetro da Community. Operações expostas pela raiz incluem Unit.LinkHolder(holderId type percentage) adicionando UnitHolder com validações, Unit.UnlinkHolder(holderId) removendo vínculo verificando que não deixa unidade sem holders se aprovada, Unit.UploadDocument(type file) criando Document anexo, Unit.AddAnnotation(content type) criando anotação, Unit.Approve() transitando status com validações pré-aprovação, Unit.Reject(reason) rejeitando com justificativa, e Unit.RequestChanges(issues) solicitando correções. Navegação para fora do agregado ocorre por referência de ID onde Unit tem CommunityId BlockId PlotId mas não carrega objetos completos evitando agregados grandes, queries podem fazer join com Community Block Plot para exibição mas mudanças neles ocorrem em seus próprios agregados, e relacionamento com Holder é especial sendo N:N mas UnitHolder é parte do agregado Unit controlando vínculo. Eventos de domínio emitidos incluem UnitCreatedEvent ao criar unidade, HolderLinkedEvent ao vincular titular, HolderUnlinkedEvent ao desvincular, UnitStatusChangedEvent em transições de workflow, DocumentUploadedEvent ao anexar arquivo, e todos eventos carregam Unit.Id permitindo subscribers reagirem. Implementação deve garantir que repository carrega Unit com todas coleções internas em single query usando eager loading, SaveChanges persiste mudanças em Unit UnitHolder Document Annotation atomicamente, e concorrência é controlada por RowVersion em Unit detectando modificações concorrentes.

**Módulos:** GEOAPI, GEOWEB, REURBCAD, GEOGIS

---

**Última atualização:** 2026-01-10
