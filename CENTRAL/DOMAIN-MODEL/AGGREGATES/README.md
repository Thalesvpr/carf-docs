# AGGREGATES

Aggregates são clusters de entidades e value objects tratados como unidade coesa para garantir invariantes de negócio onde aggregate root controla acesso e coordena mudanças de estado interno assegurando consistência transacional e integridade de dados dentro de fronteiras bem definidas implementando três aggregates principais no sistema CARF. UnitAggregate com Unit root coordenando UnitHolder relacionamento N:N com Holder Documents anexos polimórficos Annotations anotações polimórficas SurveyPoints pontos topográficos garantindo invariantes Unit deve ter ao menos um Holder antes status APPROVED, soma ownership_percentage UnitHolders ≤ 100%, exatamente um UnitHolder is_primary_holder true, geometria válida sem auto-interseções quando preenchida, área > 0 dentro limites modalidade REURB, status transitions seguem workflow permitido state machine implementando operações AddHolder RemoveHolder UpdateOwnership AttachDocument RemoveDocument AddAnnotation ResolveAnnotation UpdateGeometry RecalculateArea ChangeStatus com validação transições disparando eventos domínio UnitCreatedEvent UnitApprovedEvent UnitRejectedEvent HolderAddedEvent OwnershipChangedEvent GeometryUpdatedEvent StatusChangedEvent. CommunityAggregate com Community root coordenando Blocks quadras urbanas CommunityAuthorizations permissões acesso Team/Account Documents anexos comunidade Annotations garantindo invariantes Community deve ter ao menos uma CommunityAuthorization não pode ficar órfã, Block geometries devem estar dentro Community boundary quando definido, município obrigatório isolamento geográfico, CommunityAuthorization OU team_id OU account_id não ambos nem nenhum implementando operações AddBlock RemoveBlock GrantAccess RevokeAccess UpdateBoundary RecalculateArea AssignToTeam UnassignFromTeam disparando eventos CommunityCreatedEvent CommunityUpdatedEvent AccessGrantedEvent AccessRevokedEvent BlockAddedEvent BlockRemovedEvent BoundaryChangedEvent. LegitimationRequestAggregate com LegitimationRequest root coordenando LegitimationResponses pareceres técnicos/jurídicos LegitimationCertificate certidão oficial DescriptiveMemorial memorial descritivo técnico LegitimationPlan planta técnica gráfica Contestations contestações terceiros Documents documentação processo garantindo invariantes não aprovar sem documentação obrigatória conforme modalidade REURB-S vs REURB-E, não emitir certidão antes status APPROVED, Contestations devem estar resolvidas antes APPROVED, DescriptiveMemorial e LegitimationPlan obrigatórios approved antes conclusão, protocol_number único por tenant, deadline 120 dias contados submitted_at conforme Lei 13465/2017, status transitions seguem workflow 11 estados state machine rigorosa implementando operações Submit Approve Reject AddResponse ResolveResponse IssueCertificate RevokeCertificate HandleContestation ResolveContestation AttachMemorial AttachPlan TransitionStatus com validação role-based permissions disparando eventos RequestSubmittedEvent RequestApprovedEvent RequestRejectedEvent ResponseAddedEvent ContestationReceivedEvent ContestationResolvedEvent CertificateIssuedEvent CertificateRevokedEvent DeadlineApproachingEvent 15 dias antes vencimento StatusTransitionedEvent. Implementação segue princípios DDD tactical patterns transactional consistency mudanças dentro aggregate são atômicas consistentes, eventual consistency entre aggregates via eventos domínio processados handlers assíncronos, aggregate root único ponto acesso externo coordenando todas operações internas, small aggregates melhorando concorrência performance evitando locks longos, reference by ID aggregates referenciam outros aggregates apenas por ID não por objeto completo evitando acoplamento forte, invariants enforcement aggregate root garantindo invariantes negócio sempre respeitados validando state transitions impedindo estados inválidos protegendo integridade dados sistema.

## Aggregates

- **[UnitAggregate](./01-unit-aggregate.md)** - Unidade habitacional root
- **[CommunityAggregate](./02-community-aggregate.md)** - Comunidade/assentamento root
- **[LegitimationRequestAggregate](./03-legitimation-request-aggregate.md)** - Processo legitimação fundiária root

---

**Última atualização:** 2026-01-10
