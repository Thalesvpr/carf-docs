# Field Data Collection Workflow

Workflow de coleta de dados em campo utilizando dispositivo mobile operado por técnicos de campo (role FIELD_AGENT) visitando residências em comunidades para cadastrar Units unidades habitacionais e Holders titulares coletando informações básicas fotos e opcionalmente pontos GPS de perímetro funcionando em modo offline com sincronização posterior garantindo produtividade mesmo em áreas sem cobertura de internet. Fluxo inicia quando técnico de campo autentica em aplicativo mobile usando credenciais OAuth2 sincronizadas com servidor de autenticação, sistema verifica CommunityAuthorizations do Account identificando Communities que Team do técnico tem permissão de acessar, técnico seleciona opção de sincronização para download iniciando pull de dados autorizados onde sistema consulta endpoint de sincronização especificando ids de Communities autorizadas, servidor retorna pacote de dados incluindo Communities completas com geometrias Blocks se existentes Units já cadastradas Holders vinculados Documents anexados e metadados necessários para operação offline, aplicativo armazena dados em banco de dados local embarcado estruturado (não mencionar tecnologia específica) indexando por community_id para queries eficientes, e técnico visualiza mapa da Community selecionada com overlay de ortofoto servida via WMS se conexão estiver disponível ou mapa base offline se não houver internet. Durante coleta em campo técnico navega até residência usando GPS do dispositivo visualizando Units já cadastradas próximas para evitar duplicações, seleciona opção Criar Nova Unidade abrindo formulário de cadastro com campos obrigatórios (código gerado automaticamente endereço tipo de unidade) e opcionais (número de cômodos tipo de construção observações), desenha geometria do imóvel usando uma de três formas possíveis onde pode marcar pontos de perímetro caminhando ao redor da propriedade e aplicativo captura coordenadas GPS do dispositivo com acurácia típica de 3-5 metros formando polígono automaticamente, ou desenhar manualmente sobre mapa base/ortofoto se visível ajustando vértices por toque, ou importar geometria previamente coletada via receptor GPS externo colando coordenadas em formato texto, sistema calcula área automaticamente baseado em polígono desenhado exibindo valor em metros quadrados, técnico preenche dados do titular principal (Holder) incluindo nome completo CPF ou CNPJ telefone email se disponível e tipo de vínculo (proprietário possuidor ocupante), captura fotos do imóvel usando câmera do dispositivo incluindo obrigatoriamente foto de frente da casa e opcionalmente fotos de fundos laterais interior ou detalhes relevantes armazenando imagens localmente como Documents com document_type apropriado (PHOTO_FRONT PHOTO_BACK PHOTO_INTERIOR), opcionalmente captura documentos do titular fotografando RG CPF comprovante de residência ou escritura armazenando como Documents tipo DOC_RG DOC_CPF DOC_RESIDENCE_PROOF, técnico pode adicionar Annotations ao cadastro registrando observações importantes como pendências documentais irregularidades construtivas ou necessidade de reverificação criando Annotation tipo NOTE ou ISSUE com prioridade adequada, marca Unit como completa definindo status inicial como DRAFT indicando que cadastro foi realizado em campo mas ainda não passou por validação de analista, e sistema salva todos dados localmente em banco embarcado gerando identificador temporário único (UUID) para Unit Holder e Documents permitindo referências entre entities mesmo offline. Ao finalizar dia de campo ou quando conexão retorna técnico seleciona opção Sincronizar Dados iniciando push de dados coletados, sistema identifica entities criadas ou modificadas localmente desde última sincronização bem-sucedida marcadas com flag pending_sync, prepara pacote de sincronização serializando Units Holders Documents Annotations e metadados em formato JSON estruturado, envia requisição POST para endpoint de sincronização incluindo header de autenticação com token JWT válido e tenant_id para isolamento multi-tenant, servidor recebe pacote valida autenticação e autorização verifica que Account tem permissão create nas Communities referenciadas via CommunityAuthorization, processa cada Unit do pacote validando dados básicos (CPF válido se informado geometria é polígono fechado área dentro de limites plausíveis coordenadas dentro de bounds Brasil), detecta potenciais conflitos como Unit com mesmo código já existente ou geometria sobreposta com Unit cadastrada por outro usuário, resolve conflitos automaticamente quando possível (renumera código duplicado ajusta geometria levemente sobreposta) ou marca para resolução manual pelo técnico, persiste dados validados em banco de dados principal do servidor gerando ids definitivos substituindo UUIDs temporários, faz upload de Documents (fotos PDFs) para sistema de armazenamento de arquivos gerando URLs de acesso e armazenando metadados (tamanho hash MIME type) em entity Document, cria registros de AuditLog rastreando criação de cada entity com account_id do técnico timestamp e dados completos, retorna resposta de sincronização ao aplicativo mobile incluindo mapeamento de UUIDs temporários para ids definitivos lista de conflitos detectados e status geral (SUCCESS PARTIAL_SUCCESS CONFLICT FAILED), aplicativo atualiza banco local substituindo UUIDs por ids definitivos marca entities como sincronizadas removendo flag pending_sync, exibe notificação ao técnico informando sucesso (X unidades sincronizadas) ou conflitos requerendo atenção, e registra entrada em SyncLog local armazenando direction PUSH status resultado records_count e timestamp para troubleshooting. Em caso de conflitos irresolvíveis automaticamente sistema exibe lista detalhada de Units com problema permitindo técnico decidir ação apropriada onde pode aceitar versão do servidor descartando alterações locais, forçar versão local sobrescrevendo dados do servidor (requer permissão elevada), ou editar manualmente resolvendo diferenças antes de retentar sincronização. Workflow suporta coleta massiva onde técnico pode cadastrar dezenas ou centenas de Units em modo offline durante vários dias acumulando dados localmente, sincronização incremental envia apenas dados novos ou modificados otimizando uso de banda e tempo de sincronização, e validação em duas etapas onde validações básicas ocorrem no mobile (formato de CPF geometria válida) enquanto validações complexas (sobreposição verificação de duplicatas análise de eligibilidade) ocorrem no servidor durante sincronização permitindo feedback rápido ao técnico sem bloquear produtividade em campo. Workflow integra com outros processos onde Units criadas em campo com status DRAFT alimentam fila de trabalho de analistas para validação posterior, fotos capturadas ficam disponíveis imediatamente após sincronização para consulta por gestores ou uso em relatórios, e dados coletados via GPS de dispositivo mobile mesmo com acurácia limitada (3-5m) servem como base inicial para posterior correção por analista usando ortofoto de alta resolução ou por topógrafo usando equipamento GPS profissional (<5cm acurácia) conforme necessidade do projeto.

**Tecnologias envolvidas (implementação específica em PROJECTS/):**
- Mobile: Aplicativo com banco de dados local embarcado, GPS nativo, câmera
- Backend: API REST com endpoints de sincronização, validação, armazenamento
- Protocolos: JSON para serialização, JWT para autenticação, HTTPS para transporte

**Relacionado:**
- Entities: Unit, Holder, Document, Annotation, Community, CommunityAuthorization, SyncLog
- Value Objects: GeoPoint, Cpf, Address, PhoneNumber, Email, DocumentType, SyncStatus
- Workflows: analyst-validation-workflow.md (próximo passo após coleta)

---

**Última atualização:** 2025-01-05
