# WMS Integration Workflow

Workflow de integração com servidores WMS (Web Map Service) e WMTS (Web Map Tile Service) conforme padrões OGC (Open Geospatial Consortium) para consumo de ortofotos geradas por levantamento aerofotogramétrico via drone servindo imagens raster de alta resolução como camada de referência visual para correção de geometrias validação de cadastros e análise espacial sem necessidade de armazenar arquivos de imagem volumosos no sistema principal delegando responsabilidade de hospedagem e serving de tiles para servidor especializado externo. Fluxo inicia quando empresa de topografia ou provedor de serviços geoespaciais executa levantamento aerofotogramétrico de Community usando drone ou aeronave tripulada equipada com câmera de alta resolução (tipicamente 20-50 megapixels) voando sobre área em padrão de grid com sobreposição de 60-80% entre fotos consecutivas garantindo cobertura completa e permitindo reconstrução tridimensional, captura centenas ou milhares de fotos durante voo cobrindo extensão total da Community registrando coordenadas GPS aproximadas de cada foto via receptor embarcado no drone, coleta pontos de controle terrestres (ground control points) distribuídos pela área usando receptor GNSS de precisão posicionando alvos visíveis (lonas com padrão xadrez marcos pintados) em localizações conhecidas com acurácia centimétrica servindo como referência para georreferenciamento preciso de ortofoto, processa fotos capturadas usando software de fotogrametria digital (não mencionar marca específica) executando estruture-from-motion para reconstruir nuvem de pontos tridimensional da área bundle adjustment para refinar parâmetros de câmera e posições de fotos e ortorretificação para gerar imagem bidimensional corrigida de distorções de relevo e perspectiva, utiliza pontos de controle terrestres durante processamento garantindo que ortofoto resultante tem precisão posicional horizontal tipicamente melhor que 10cm (depende de GSD - Ground Sample Distance que varia com altura de voo e resolução de câmera), gera ortofoto final como arquivo raster georreferenciado (GeoTIFF ou formato similar) com resolução espacial (GSD) entre 2-10cm por pixel adequada para identificação de edificações limites de propriedade e features urbanas detalhadas, e cria metadados descrevendo ortofoto incluindo bounds geográficos sistema de coordenadas data de captura resolução espacial e fonte de dados. Após geração de ortofoto provedor prepara publicação via servidor WMS/WMTS instalando ou utilizando servidor de mapas compatível com padrões OGC (não mencionar software específico mas exemplos genéricos incluem servidores open-source ou soluções comerciais de GIS), importa ortofoto para servidor configurando layer identificador único (exemplo ortofoto_comunidade_x_2024) título descritivo sistema de coordenadas (tipicamente EPSG:3857 Web Mercator para compatibilidade web ou EPSG:31983 SIRGAS 2000 UTM para Brasil) bounds geográficos e metadados adicionais, configura estilos de renderização se necessário (tipicamente ortofoto usa estilo padrão sem ajustes) e opções de resampling para gerar tiles em múltiplas escalas, habilita protocolos WMS e WMTS no servidor expondo endpoints públicos ou autenticados conforme política de acesso, executa GetCapabilities request testando que servidor retorna documento XML válido listando layers disponíveis formatos suportados sistemas de coordenadas e operações permitidas, valida que tiles são gerados corretamente executando GetMap requests de teste verificando que imagens retornadas correspondem a região solicitada e qualidade é adequada, e fornece URL base do servidor WMS credenciais de acesso se necessário e identificador de layer ao cliente (tenant do sistema CARF) para configuração. ADMIN do tenant acessa interface de configuração de WmsServers no sistema CARF selecionando opção Adicionar Servidor WMS, preenche formulário com informações fornecidas por provedor incluindo name descritivo (Ortofoto Aerofotogrametria Community X), base_url apontando para endpoint do servidor (exemplo https://wms.provedor.com/service), version do protocolo WMS suportado (tipicamente 1.1.1 ou 1.3.0), service_type especificando WMS ou WMTS conforme protocolo disponível, username e password se servidor requer autenticação basic ou token-based armazenando credenciais de forma criptografada (hash ou encryption não plaintext), e observações adicionais descrevendo provedor período de validade de dados ou restrições de uso, sistema valida conectividade executando requisição GetCapabilities ao base_url fornecido verificando que servidor responde dentro de timeout configurável (exemplo 10 segundos) e retorna documento XML bem formado, parseia resposta GetCapabilities extraindo lista de layers disponíveis formatos de imagem suportados (PNG JPEG GeoTIFF) sistemas de coordenadas oferecidos bounds geográficos de cada layer e metadados adicionais, armazena capabilities_cache como JSON estruturado em WmsServer entity permitindo consultas rápidas sem necessidade de repetir GetCapabilities a cada uso, cria WmsServer entity com active true indicando que servidor está disponível para uso last_validated_at com timestamp atual e exibe confirmação ao ADMIN listando layers descobertos. ADMIN seleciona layers relevantes de lista retornada por GetCapabilities decidindo quais ortofotos devem ser disponibilizadas para usuários do sistema, para cada layer de interesse cria WmsLayer entity preenchendo wms_server_id vinculando a WmsServer cadastrado, layer_name copiando identificador exato retornado por GetCapabilities (exemplo ortofoto_comunidade_x_2024), display_name fornecendo nome amigável para exibição em interface (Ortofoto Community X - Janeiro 2024 - GSD 3cm), opacity configurando transparência inicial da camada (tipicamente 0.8 ou 80% permitindo visualização de layers vetoriais sobrepostos), z_index definindo ordem de empilhamento no mapa (valores menores aparecem abaixo valores maiores acima tipicamente ortofoto tem z_index baixo como 1 ou 2 para ficar sob layers vetoriais), visible_by_default boolean indicando se layer deve estar ativado ao carregar mapa ou se usuário precisa ativar manualmente (tipicamente true para ortofoto principal false para layers auxiliares), visible_to_roles array JSON de roles autorizados a visualizar layer implementando controle de acesso granular onde ortofotos sensíveis podem ser restritas a ADMIN e MANAGER, e metadados opcionais como bounds geográficos sistema de coordenadas suportado e data de captura copiados de capabilities. Sistema associa WmsLayers a Communities específicas permitindo que ao abrir Community no mapa layers relevantes sejam carregadas automaticamente, ADMIN pode configurar vinculação via interface selecionando Community e atribuindo WmsLayers disponíveis ou sistema pode inferir automaticamente baseado em intersecção de bounds (se bounds de WmsLayer intersecciona geometria de Community layer é relevante), e configuração é persistida permitindo experiência consistente para usuários que trabalham repetidamente na mesma Community. Usuários finais (ANALYST FIELD_AGENT MANAGER) ao acessar mapa de Community no sistema web ou aplicativo mobile sistema carrega automaticamente WmsLayers configuradas para aquela Community verificando visible_to_roles para filtrar layers não autorizadas para role do usuário atual, adiciona cada WmsLayer autorizada como camada raster no componente de mapa usando biblioteca de mapas do frontend (não mencionar biblioteca específica mas exemplos genéricos incluem bibliotecas JavaScript de mapas interativos), configura layer com opacity e z_index definidos garantindo renderização apropriada com layers vetoriais de Units Communities e Blocks, executa requisições GetMap ao servidor WMS solicitando tiles para viewport atual do mapa especificando bounds geográficos largura e altura em pixels sistema de coordenadas (CRS) formato de imagem desejado (PNG para transparência ou JPEG para menor tamanho) e styles se aplicável, servidor WMS processa requisição renderizando porção de ortofoto correspondente a bounds solicitados aplicando reprojeção se CRS solicitado difere de CRS nativo da ortofoto e retorna imagem raster, frontend recebe imagem e renderiza no mapa sobrepondo ou subjacente a layers vetoriais conforme z_index permitindo visualização integrada de ortofoto e dados cadastrais, e usuário pode interagir com layer ajustando opacity via slider ativando ou desativando visibilidade via checkbox ou alterando ordem de layers arrastando em painel de controle. Durante uso de ortofoto para correção de geometrias analista visualiza Units sobrepostas sobre ortofoto identificando discrepâncias entre polígonos cadastrados e edificações reais visíveis na imagem, ativa modo de edição de geometria na ferramenta GIS ou interface web selecionando Unit a corrigir, ajusta vértices de polígono arrastando para alinhar com cantos de edificação visíveis na ortofoto usando snap automático ou manual conforme ferramenta disponível, valida visualmente que polígono corrigido cobre footprint de edificação sem extrapolações ou omissões significativas, salva alterações enviando geometria atualizada para API do sistema via requisição PUT ou PATCH, e API persiste geometria corrigida recalculando área automaticamente e criando registro de auditoria rastreando quem modificou quando e qual foi mudança. Sistema implementa caching de tiles WMS no lado do cliente e/ou servidor intermediário para otimizar performance e reduzir requisições repetitivas ao servidor WMS externo, armazena tiles baixados em cache local (browser cache ou cache de aplicativo mobile) com TTL configurável (exemplo 7 dias) permitindo reutilização sem download, proxy server pode implementar caching adicional interceptando requisições GetMap verificando se tile já está em cache antes de repassar para servidor WMS externo reduzindo latência e custo de banda especialmente útil se servidor WMS externo cobra por volume de dados transferidos, e cache é invalidado automaticamente após TTL ou manualmente quando ADMIN atualiza WmsLayer indicando que nova versão de ortofoto foi publicada. Sistema executa manutenção periódica de WmsServers através de job agendado que executa diariamente ou semanalmente revalidando conectividade de cada WmsServer ativo executando GetCapabilities verificando se servidor ainda responde dentro de timeout, atualizando capabilities_cache com metadados mais recentes refletindo mudanças em layers disponíveis ou bounds atualizados, marcando WmsServer como active false se servidor está inacessível por período prolongado (exemplo 3 falhas consecutivas) e notificando ADMIN sobre indisponibilidade para providências, e registrando last_validated_at com timestamp de última verificação bem-sucedida permitindo identificação de servidores que não foram validados recentemente. Workflow suporta múltiplos provedores de WMS permitindo que tenant configure WmsServers de diferentes fornecedores (empresa A fornece ortofoto de 2023 empresa B fornece ortofoto de 2024 IBGE fornece imagens de satélite) oferecendo flexibilidade e redundância, versionamento de ortofotos onde múltiplas WmsLayers podem referenciar mesmo WmsServer mas layers diferentes representando capturas em datas distintas permitindo comparação temporal de evolução de ocupação de área, e integração com outros tipos de camadas WMS além de ortofotos como mapas temáticos (uso do solo zoneamento) imagens de satélite multiespectrais ou modelos digitais de elevação renderizados como hillshade ampliando capacidades de análise espacial do sistema.

**Tecnologias envolvidas (implementação específica em PROJECTS/):**
- Aerofotogrametria: Drone, câmera alta resolução, software de fotogrametria digital
- WMS/WMTS: Servidor de mapas compatível OGC, protocolo HTTP, XML para capabilities, imagens PNG/JPEG
- Frontend: Biblioteca de mapas JavaScript, componentes de controle de layers, caching de tiles
- Backend: API REST para configuração de WmsServers, proxy opcional para caching, validação periódica

**Relacionado:**
- Entities: WmsServer, WmsLayer, Community, Unit
- Workflows: analyst-validation-workflow.md (principal consumidor de ortofoto WMS)
- Padrões: OGC WMS 1.1.1/1.3.0, WMTS, EPSG:3857, EPSG:31983

---

**Última atualização:** 2025-01-05
**Status do arquivo**: Review
