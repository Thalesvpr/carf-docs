# Analyst Validation Workflow

Workflow de validação e correção em massa de Units por analistas (role ANALYST ou superior) utilizando ferramenta GIS desktop com plugin conectado à API do sistema permitindo visualização de ortofoto de alta resolução servida via WMS como camada de referência para correção precisa de geometrias de unidades habitacionais cadastradas em campo ajustando polígonos para alinharem perfeitamente com footprints de edificações visíveis na imagem aérea maximizando acurácia espacial e produtividade através de edição em lote. Fluxo inicia quando analista autentica em ferramenta GIS desktop usando plugin especializado que solicita credenciais OAuth2, plugin redireciona para servidor de autenticação retornando token JWT após login bem-sucedido, analista configura conexão com API especificando URL base do servidor (ambiente produção staging ou desenvolvimento) e tenant_id se aplicável, plugin valida conectividade executando requisição de health check e carrega metadados de tenant incluindo Communities disponíveis e configurações de WmsServers cadastrados. Analista seleciona Community de interesse em interface do plugin especificando filtros opcionais como status de Units (DRAFT PENDING_ANALYSIS IN_REVIEW) ou data de cadastro, plugin executa requisição GET para endpoint de Units incluindo query parameters de filtro autenticação via header Authorization Bearer e tenant_id, servidor valida CommunityAuthorization verificando que Account do analista tem permissão can_read na Community solicitada, retorna coleção de Units serializadas em formato GeoJSON incluindo geometrias atributos (code address area_sqm status has_improvements) e metadados de Holders vinculados, plugin processa GeoJSON criando layer vetorial editável na ferramenta GIS com Units renderizadas como polígonos coloridos conforme status (verde APPROVED amarelo PENDING_ANALYSIS vermelho REQUIRES_CHANGES cinza DRAFT), e analista visualiza mapa com Units distribuídas espacialmente sobre Community. Para habilitar correção precisa analista adiciona camada WMS de ortofoto selecionando WmsServer cadastrado para Community em lista disponível no plugin, plugin consulta endpoint de WmsServers filtrando por Community ou Tenant retornando lista de servidores configurados, analista seleciona WmsLayer específica correspondendo a ortofoto mais recente da Community (exemplo Ortofoto Comunidade X 2024 GSD 3cm), plugin executa requisição GetCapabilities ao WmsServer especificado validando disponibilidade e obtendo metadados de layer (bounds CRS formatos suportados), adiciona WmsLayer como camada raster na ferramenta GIS posicionando abaixo de layer vetorial de Units para servir como background de referência, configura opacity da camada WMS (tipicamente 70-90%) permitindo visualização simultânea de ortofoto e polígonos de Units, e analista visualiza ortofoto de alta resolução (GSD 2-5cm por pixel) mostrando claramente edificações ruas vegetação e outras features físicas da comunidade. Processo de correção em massa inicia com analista ativando modo de edição da layer de Units habilitando ferramentas de edição vetorial da ferramenta GIS, analista seleciona Unit com geometria imprecisa (polígono desalinhado com edificação visível na ortofoto) identificada visualmente ou através de filtro de Units com flag requires_geometry_correction, utiliza ferramentas de edição (mover vértices adicionar vértices deletar vértices reshape polygon) para ajustar polígono fazendo snap de vértices às quinas de edificação visíveis na ortofoto, sistema GIS desktop recalcula área automaticamente após cada edição atualizando atributo area_sqm da Unit, analista pode adicionar Annotation à Unit registrando observação sobre correção realizada (Ajustado conforme ortofoto 2024 ou Edificação parcialmente demolida ajustar em próxima visita) criando Annotation tipo NOTE vinculada à Unit via plugin, marca Unit como validada alterando status de PENDING_ANALYSIS para IN_REVIEW indicando que geometria foi corrigida e aguarda aprovação final de gestor, e repete processo para próxima Unit acumulando edições localmente na ferramenta GIS antes de enviar ao servidor. Workflow otimiza produtividade através de edição em lote onde analista pode selecionar múltiplas Units simultaneamente aplicando operações em massa como alterar status de 50 Units de DRAFT para PENDING_ANALYSIS após validação visual rápida, usar ferramenta de snap automático que ajusta vértices de polígono para alinhar com edges detectados na ortofoto usando algoritmo de detecção de bordas, copiar geometria de Unit próxima quando edificações são idênticas (casas geminadas com mesmo tamanho e formato) aplicando offset horizontal, validar topologia automaticamente detectando polígonos auto-interseccionados gaps entre Units adjacentes ou sobreposições inválidas exibindo relatório de erros para correção, e aplicar regras de negócio como validar que área de Unit está dentro de limites permitidos para modalidade REURB (≤250sqm REURB-S ≤500sqm REURB-E) destacando Units fora de compliance. Após finalizar sessão de edição analista salva alterações localmente e inicia processo de upload ao servidor, plugin prepara pacote de sincronização serializando Units modificadas incluindo geometrias atualizadas atributos alterados Annotations criadas e metadados de edição (account_id timestamp coordenadas do sistema de referência), executa requisição PUT ou PATCH para endpoint de Units enviando pacote JSON com alterações, servidor valida autenticação e CommunityAuthorization verificando que analista tem permissão can_edit na Community, valida cada Unit modificada verificando geometria é polígono válido área recalculada bate com geometria status transition é permitido (DRAFT pode ir para PENDING_ANALYSIS PENDING_ANALYSIS pode ir para IN_REVIEW), detecta conflitos de edição concorrente comparando version field verificando se Unit foi modificada por outro usuário desde que analista fez download, resolve conflitos usando estratégia last-write-wins se configurado ou retorna erro solicitando que analista faça refresh e reaplique edições manualmente, persiste alterações validadas em banco de dados principal atualizando geometrias atributos incrementando version field, cria registros de AuditLog capturando old_values e new_values de cada campo modificado para rastreabilidade completa, retorna resposta de sucesso ao plugin incluindo ids de Units atualizadas conflitos detectados e mensagens de validação, e plugin exibe notificação ao analista confirmando sincronização bem-sucedida (X unidades atualizadas) ou listando problemas requerendo atenção. Workflow integra validação de dados onde analista verifica completude de informações de Holder associado à Unit validando presença de CPF nome telefone e documentos obrigatórios, identifica duplicatas potenciais comparando CPF de Holders ou proximidade espacial de Units sinalizando casos suspeitos para investigação, valida consistência entre área declarada e área calculada de geometria alertando se divergência excede threshold configurável (exemplo 10%), e marca Units como REQUIRES_CHANGES retornando para status anterior quando identifica problemas que requerem nova visita de campo (edificação demolida endereço incorreto titular mudou) criando Annotation detalhando correções necessárias para orientar técnico de campo. Analista pode gerar relatórios de progresso de validação consultando estatísticas de Units por status dentro de Community visualizando dashboard com métricas (total cadastradas total validadas percentual de aprovação tempo médio de validação por Unit), exportar Units validadas para formatos GIS padrão (Shapefile GeoJSON KML) para compartilhamento com outros sistemas ou backup, e visualizar histórico de edições de Unit específica consultando AuditLog entries mostrando quem modificou o quê e quando permitindo auditoria de qualidade e resolução de disputas. Workflow finaliza quando analista marca batch de Units como IN_REVIEW sinalizando que validação está completa e Units estão prontas para aprovação final por MANAGER, sistema automaticamente notifica gestores responsáveis sobre Units pendentes de aprovação através de dashboard ou email, e Units aprovadas por gestor transicionam para status APPROVED habilitando próximos passos do processo como geração de memorial descritivo por topógrafo ou início de processo de legitimação fundiária.

**Tecnologias envolvidas (implementação específica em PROJECTS/):**
- Desktop GIS: Ferramenta com plugin conectando à API via HTTP, edição vetorial, visualização WMS
- Backend: API REST com endpoints CRUD de Units, autenticação, autorização
- WMS: Protocolo OGC para servir ortofoto raster, GetCapabilities, GetMap

**Relacionado:**
- Entities: Unit, Holder, Community, CommunityAuthorization, WmsServer, WmsLayer, Annotation, AuditLog
- Value Objects: GeoPoint, UnitStatus, AnnotationType
- Workflows: field-data-collection-workflow.md (passo anterior), topography-workflow.md (próximo passo)

---

**Última atualização:** 2025-01-05
