---
modules: [GEOAPI]
epic: security
---

# RNF-025: Isolamento de Tenants

O sistema GEOMAP5 deve implementar isolamento rigoroso de dados entre diferentes tenants (municípios ou organizações) através de Row Level Security (RLS) no PostgreSQL e validações na camada de aplicação GEOAPI, garantindo que seja absolutamente impossível para um usuário ou administrador de um tenant acessar, visualizar ou modificar dados pertencentes a outro tenant, mesmo em caso de bugs na aplicação ou tentativas deliberadas de bypass. A implementação deve habilitar Row Level Security no nível de banco de dados PostgreSQL para todas as tabelas que contêm dados específicos de tenant, incluindo unidades habitacionais, titulares, comunidades, documentos e quaisquer outras entidades de domínio, criando policies que automaticamente filtram todas as queries SELECT, INSERT, UPDATE e DELETE baseadas em uma coluna tenant_id presente em cada tabela. O contexto de tenant do usuário autenticado deve ser estabelecido no início de cada transação de banco de dados através de variáveis de sessão PostgreSQL, onde a policy de RLS compara automaticamente o tenant_id da sessão com o tenant_id de cada registro, tornando o filtro transparente e à prova de erros de implementação na camada de aplicação. Na camada de aplicação GEOAPI, middlewares devem extrair o tenant_id do token JWT do usuário autenticado e configurá-lo no contexto da requisição, onde todos os repositories e services devem utilizar esse contexto para aplicar filtros adicionais mesmo antes das queries chegarem ao banco, criando uma defesa em profundidade. Testes automatizados de isolamento de tenant devem ser implementados, simulando tentativas de acesso a dados de outros tenants através de manipulação de parâmetros de API, modificação de headers HTTP e tentativas de SQL injection, garantindo que todas essas tentativas resultem em acesso negado ou retorno de conjunto vazio de dados. Logs de auditoria devem registrar qualquer tentativa de acesso cross-tenant bloqueada, permitindo identificação de tentativas maliciosas ou bugs que possam estar gerando queries inadequadas. A arquitetura deve ser preparada para evolução futura para complete database separation por tenant se necessário, mantendo a lógica de isolamento modular e configurável. Este requisito é Must-have pois vazamento de dados entre tenants seria uma violação crítica de segurança e confiança, potencialmente expondo informações sensíveis de cidadãos de uma cidade para administradores de outra, com graves consequências legais e reputacionais.
