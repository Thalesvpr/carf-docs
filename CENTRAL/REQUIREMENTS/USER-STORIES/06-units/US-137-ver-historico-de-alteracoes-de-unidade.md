---
modules: [GEOAPI, GEOWEB]
epic: performance
---

# US-137: Ver Historico de Alteracoes de Unidade

Como Analista quero visualizar timeline de modificacoes em uma unidade para que possa auditar mudancas rastrear responsaveis e entender evolucao do cadastro ao longo do tempo, onde o endpoint implementado em GEOAPI expoe a rota /api/units/{id}/history retornando lista ordenada cronologicamente de eventos de auditoria da unidade habitacional, garantindo validacao de permissoes baseada em roles onde usuarios com role Analyst ou superior podem visualizar historico de unidades do seu tenant e usuarios com role Auditor podem visualizar historico completo incluindo campos sensiveis, incluindo tratamento de erro 404 Not Found quando ID da unidade nao existe e validacao de isolamento multi-tenant impedindo acesso a historico de unidades de outros tenants, permitindo que a resposta inclua array de objetos AuditEvent ordenados por timestamp decrescente contendo propriedades id eventType timestamp userId userName userEmail action entityName fieldName oldValue newValue ipAddress userAgent e metadata, onde eventType indica tipo de evento incluindo CREATED UPDATED STATUS_CHANGED GEOMETRY_MODIFIED HOLDER_LINKED HOLDER_UNLINKED DOCUMENT_ATTACHED DOCUMENT_REMOVED COMMENT_ADDED, garantindo rastreabilidade ao requisito funcional RF-057 que especifica auditoria de alteracoes em unidades, incluindo captura automatica de eventos atraves de interceptors do Entity Framework Core que registram mudancas antes de SaveChanges ser executado, permitindo visualizacao de diff detalhado para campos modificados onde oldValue e newValue sao serializados em JSON permitindo comparacao lado a lado no frontend, onde alteracoes em geometria sao registradas com hash MD5 da geometria anterior e nova para detectar modificacoes sem armazenar geometrias completas no log de auditoria economizando espaco de armazenamento, garantindo que dados sensiveis como senhas tokens de autenticacao e informacoes pessoais protegidas por LGPD sejam mascarados no historico mesmo quando auditados, incluindo filtragem do historico por parametros de query eventType dateRange userId fieldName permitindo analistas investigar mudancas especificas sem navegar timeline completa, permitindo que o frontend GEOWEB exiba timeline interativa com cards de eventos icones diferenciados por tipo de acao cores indicando criacao atualizacao e exclusao e tooltips com detalhes completos do evento, onde a implementacao em GEOAPI utiliza tabela dedicada audit_logs com indices em unit_id timestamp event_type para garantir performance de queries de historico mesmo com milhoes de registros de auditoria, garantindo retencao de logs de auditoria configuravel por politica com arquivamento automatico de eventos antigos para storage de longo prazo tipo S3 ou Azure Blob mantendo apenas ultimos 12 meses em banco hot, incluindo export do historico em formatos CSV PDF e JSON para uso em auditorias formais investigacoes de compliance e relatorios regulatorios, onde testes unitarios validam captura de eventos de auditoria em diferentes cenarios de modificacao incluindo atualizacoes parciais batch updates e cascading deletes, garantindo testes de integracao que verificam registro correto de eventos em banco de dados validacao de mascaramento de dados sensiveis e integridade referencial entre audit_logs e tabelas users units, incluindo testes de performance que validam que queries de historico executam em menos de 500ms mesmo com 100mil eventos de auditoria para uma unidade especifica.

---

**Ultima atualizacao:** 2025-12-30
