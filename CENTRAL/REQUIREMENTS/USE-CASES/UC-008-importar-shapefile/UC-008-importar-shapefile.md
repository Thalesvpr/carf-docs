---
modules: [GEOWEB, REURBCAD, GEOGIS]
epic: scalability
---

# UC-008: Importar Shapefile

Caso de uso permitindo usuários técnicos autorizados (ADMIN com permissão units.import para importar unidades habitacionais em massa, TECHNICAL_USER com layers.import para importar features geográficas customizadas) carregarem múltiplos registros simultaneamente a partir de arquivo Shapefile padrão ESRI contendo geometrias e atributos previamente preparados em software GIS externo como QGIS ArcGIS ou AutoCAD Map após autenticação e disponibilidade de arquivo ZIP válido contendo componentes obrigatórios do Shapefile, onde fluxo principal inicia com acesso ao menu Importar Dados exibindo opções de tipo de importação oferecendo Importar Unidades criando registros em tabela units associados à comunidade ou Importar Features em Camada criando registros genéricos em camada customizada configurável, usuário seleciona tipo desejado abrindo wizard de importação estruturado em 3 passos sequenciais (Upload Mapeamento Preview) guiando processo complexo com validações progressivas, Passo 1 Upload exibe dropzone com instruções "Arraste arquivo ZIP contendo .shp .shx .dbf .prj ou clique para selecionar" aceitando apenas arquivos .zip, usuário faz upload de arquivo ZIP previamente preparado compactando componentes Shapefile obrigatórios (.shp geometrias binário, .shx índice espacial, .dbf atributos dBase) e opcionais (.prj definição de projeção WKT, .cpg codificação de caracteres), sistema valida presença de arquivos mínimos verificando ZIP contém ao menos .shp e .dbf rejeitando uploads incompletos, valida tamanho total <50MB prevenindo importações gigantes que travem sistema ou excedam memória disponível, extrai ZIP para diretório temporário em servidor usando biblioteca unzipper, valida estrutura interna do Shapefile usando biblioteca shapefile npm tentando abrir .shp e ler header verificando magic number 9994 e version 1000 confirmando formato válido, lê total de features do header exibindo mensagem confirmação "Arquivo válido. 250 registros encontrados" com ícone verde checkmark, botão Próximo habilitado permitindo avançar, Passo 2 Mapeamento de Campos detecta automaticamente campos do arquivo .dbf lendo schema com nomes e tipos (COD_UNID String, AREA_M2 Number, TIPO_USO String), exibe tabela interativa de mapeamento com três colunas mostrando Campo Shapefile (labels extraídos do .dbf), Tipo (detectado automaticamente), Campo Sistema (dropdown listando campos disponíveis na entidade destino como código endereço tipo area_m2 status permitindo usuário mapear cada coluna externa para campo interno), sistema sugere mapeamento automático usando fuzzy matching de nomes tentando parear COD_UNID → código, ENDERECO → endereço, AREA → area_m2 reduzindo trabalho manual, usuário ajusta mapeamentos conforme necessário corrigindo sugestões incorretas ou mapeando campos não detectados automaticamente, se importando unidades usuário seleciona comunidade destino usando dropdown de communities listando todas do tenant onde units criadas serão associadas via foreign key community_id, valida ao menos campos obrigatórios mapeados verificando código e geometry não null exibindo erro se faltantes "Campo obrigatório 'Código' não foi mapeado. Selecione coluna correspondente", botão Próximo habilitado após validação, Passo 3 Preview e Confirmação executa validação preliminar processando primeiros 10 registros como amostra, exibe tabela de preview com 10 linhas mostrando valores mapeados em colunas do sistema permitindo usuário revisar visualmente se mapeamento correto, renderiza mapa de preview usando Leaflet exibindo geometrias dos 10 primeiros registros coloridas em azul com popup mostrando atributos ao clicar permitindo validação espacial visual, executa validação completa de todas geometrias usando PostGIS ST_IsValid processando todas features em background e exibe resumo estatístico mostrando Total de Registros 250, Geometrias Válidas 248 com checkmark verde, Geometrias Inválidas 2 com lista expansível detalhando IDs problemáticos "Feature 45: Self-intersection, Feature 128: Ring not closed" orientando sobre problemas a corrigir no arquivo fonte antes de importar, usuário revisa informações marca checkbox Criar Unidades em Status Draft garantindo registros importados entram como rascunho aguardando aprovação ao invés de aprovados automaticamente evitando poluir dados produção com importações não revisadas, clica botão Importar confirmando início do processamento, sistema cria job de importação em background inserindo registro em tabela import_jobs com user_id filename mappings status=PENDING enfileira em BullMQ queue imports-queue, exibe toast azul "Importação iniciada. Acompanhe progresso na página de importações" com link clicável, worker dedicado consome job executando processamento iterando cada feature do shapefile lendo geometrias e atributos, valida geometria individual usando PostGIS ST_IsValid(geom) verificando topologia correta, reprojeciona para EPSG:4326 padrão de armazenamento usando ST_Transform se SRID detectado do .prj diferente convertendo coordenadas preservando precisão, mapeia campos aplicando transformações configuradas extraindo valores de atributos DBF e atribuindo a campos destino respeitando tipos (String → VARCHAR, Number → NUMERIC, Date → TIMESTAMP), valida dados aplicando regras de negócio verificando CPF válido com algoritmo verificador se campo mapeado, campos obrigatórios não null, valores em ranges aceitáveis, cria unidade no banco executando INSERT INTO units com transaction garantindo atomicidade, registra erros em import_errors table se validação falhar armazenando feature_index error_code error_message permettindo diagnóstico posterior, atualiza progresso do job incrementando processed_count e calculando percentage = (processed / total) * 100 permitindo UI exibir barra de progresso em tempo real via polling ou WebSocket, ao concluir todas features marca job como COMPLETED ou COMPLETED_WITH_ERRORS dependendo de presença de erros, sistema envia notificação push ao usuário mostrando "Importação concluída: 245 de 250 unidades importadas com sucesso" com link Ver Relatório, usuário acessa página Minhas Importações listando todos import_jobs do tenant ordenados por created_at DESC, clica em importação específica abrindo relatório detalhado exibindo estatísticas Importadas com Sucesso 245 em verde, Com Erro 5 em vermelho com botão Download Log de Erros gerando CSV contendo feature_id campo_problemático valor_inválido mensagem_erro permitindo ANALYST corrigir Shapefile fonte e reimportar apenas registros falhados. Fluxo alternativo permite importar GeoJSON ao invés de Shapefile (UC-008-FA-001). Fluxos de exceção cobrem arquivo inválido com componentes faltantes (UC-008-FE-001), SRID desconhecido com fallback para assumir EPSG:4326 (UC-008-FE-002), duplicatas detectadas pelo código único pulando registro (UC-008-FE-003), e geometrias inválidas com tentativa de correção via ST_MakeValid (UC-008-FE-004).

**Fluxos Alternativos:**
- UC-008-FA-001: Importar GeoJSON

**Fluxos de Exceção:**
- UC-008-FE-001: Arquivo inválido
- UC-008-FE-002: SRID desconhecido
- UC-008-FE-003: Duplicatas detectadas
- UC-008-FE-004: Geometrias inválidas

**Regras de Negócio:**
- RN-001: Limite máximo 10.000 features por importação prevenindo timeout e consumo excessivo de memória
- RN-002: Geometrias devem ser tipo esperado (Polygon ou MultiPolygon para unidades, rejeitando Point ou LineString)
- RN-003: Campos obrigatórios (código geometry) devem ser mapeados validando antes de iniciar processamento
- RN-004: Unidades importadas sempre entram em status DRAFT exigindo aprovação posterior via UC-002
- RN-005: Duplicatas identificadas por código único são puladas mantendo registro original preservando dados existentes

**Rastreabilidade:**
- RF-040, RF-067, RF-139, RF-140
- US-020

---

**Última atualização:** 2025-12-30
