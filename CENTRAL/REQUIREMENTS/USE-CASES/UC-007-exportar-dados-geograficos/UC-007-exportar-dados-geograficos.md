---
modules: [GEOWEB, REURBCAD, GEOGIS]
epic: scalability
---

# UC-007: Exportar Dados Geográficos

Caso de uso permitindo usuários autorizados (ANALYST com permissão exports.create para análise cadastral, MANAGER para relatórios gerenciais, ADMIN com acesso total, TECHNICAL_USER usando plugin QGIS para integração externa) exportarem unidades habitacionais e features geográficas em formatos GIS padrão (Shapefile GeoJSON KML CSV Excel) para uso em ferramentas externas como ArcGIS QGIS Google Earth planilhas após autenticação e seleção de dados a exportar, onde fluxo principal inicia com acesso à lista de unidades exibindo grid paginado com todas units do tenant, usuário aplica filtros desejados usando controles de busca incluindo dropdown de comunidade filtro de status (DRAFT PENDING APPROVED REJECTED), seletor de período com data_inicio e data_fim para filtrar por created_at ou updated_at, filtro de tipo de unidade (Residencial Comercial Misto), sistema executa query dinâmica aplicando cláusulas WHERE combinadas com AND refletindo filtros selecionados e exibe resultados filtrados mostrando contador "350 unidades encontradas" permitindo usuário validar subset antes de exportar, usuário clica botão Exportar no canto superior direito da listagem disparando abertura de modal de exportação exibindo formulário com opções de customização incluindo radio buttons de formato oferecendo Shapefile (padrão indústria para desktop GIS mantendo compatibilidade com ArcGIS QGIS AutoCAD), GeoJSON (formato web moderno leve ideal para aplicações JavaScript Leaflet OpenLayers), KML (visualização em Google Earth compatível com Google Maps), CSV (tabela simples sem geometrias apenas lat/lon em colunas separadas), Excel (XLSX formatado para análise não-GIS em Microsoft Excel LibreCalc), checkbox Incluir Fotos/Documentos habilitado apenas para Shapefile adicionando pasta /fotos dentro do ZIP com imagens JPEG nomeadas {unit_id}_{photo_index}.jpg, dropdown de sistema de coordenadas listando EPSG:4326 (WGS84 lat/lon usado por GPS e web), EPSG:31982 (SIRGAS 2000 UTM zona 22S oficial Brasil), EPSG:31983 (zona 23S), outros SRIDs relevantes permitindo reprojeção para workflow específico de usuário, e checkboxes de campos a exportar com opção Todos pré-marcada ou lista permitindo desmarcar campos sensíveis (CPF emails) respeitando LGPD e reduzindo tamanho de arquivo, usuário seleciona opções configurando formato SRID campos e clica Exportar disparando validação verificando formato não null, se registros selecionados ≤10.000 respeitando limite técnico de performance e tamanho de arquivo razoável (~50MB típico para 10k registros Shapefile), se validação passa sistema cria job de exportação inserindo registro em tabela export_jobs com user_id filters format options status=PENDING enfileira job em BullMQ queue exports-queue, exibe toast azul "Exportação iniciada. Você será notificado quando pronto" e fecha modal retornando usuário para listagem, worker dedicado consome job executando processamento busca dados conforme filtros aplicando mesma query WHERE usada na listagem garantindo consistência mas selecionando todos campos necessários incluindo ST_AsText(geometry) para conversão, reprojeciona geometrias se SRID diferente do armazenado usando PostGIS ST_Transform(geometry, target_srid) convertendo coordenadas matematicamente com precisão milimétrica, formata dados conforme formato selecionado onde para Shapefile usa biblioteca shapefile npm criando arquivos binários .shp (geometrias), .shx (índice espacial), .dbf (atributos em dBase formato legado), .prj (definição de projeção WKT) compactando tudo em ZIP, para GeoJSON serializa objeto FeatureCollection JSON seguindo especificação RFC 7946 com features array contendo cada unidade como Feature com properties e geometry type Point/Polygon, para KML gera XML seguindo schema OGC incluindo tags Placemark Style com cores diferentes por status e tags ExtendedData para atributos customizados, para CSV gera tabela delimitada por vírgula com header row contendo nomes de colunas e colunas lat lon extraídas de ST_X ST_Y do centroide da geometria, para Excel usa biblioteca ExcelJS criando workbook com sheet Unidades aplicando estilos headers bold zebra striping freeze panes e filtros automáticos, se Incluir Fotos marcado busca binários de photos table via foreign key unit_id salva cada imagem em pasta fotos/ dentro do ZIP final com nome preservando referência, salva arquivo gerado em object storage AWS S3 ou Azure Blob em bucket exports/ com key export_{job_id}_{timestamp}.zip garantindo unicidade e rastreabilidade, gera URL presigned com TTL 24 horas permitindo download autenticado temporário sem expor bucket público, marca job como COMPLETED atualizando status, sistema envia notificação push via WebSocket ou email mostrando "Exportação concluída: 350 unidades em Shapefile" com link Baixar Agora, usuário clica em notificação ou acessa menu Downloads listando todas exportações recentes ordenadas por created_at DESC com colunas mostrando formato quantidade status data, clica botão Baixar iniciando download do arquivo ZIP salvando localmente com nome descritivo Exportacao_Unidades_Vila_Nova_2025-12-30.zip permitindo descompactar e abrir em QGIS ou ferramenta escolhida visualizando geometrias com atributos completos prontos para análise espacial sobreposição com outras camadas ou geração de mapas temáticos. Fluxos alternativos incluem exportação rápida síncrona para <100 registros (UC-007-FA-001) e exportar apenas unidades selecionadas via checkboxes (UC-007-FA-002). Fluxos de exceção cobrem limite de 10.000 registros excedido (UC-007-FE-001), geometrias inválidas detectadas e ignoradas (UC-007-FE-002), e erro de reprojeção com fallback para SRID original (UC-007-FE-003).

**Fluxos Alternativos:**
- UC-007-FA-001: Exportação rápida (poucos dados)
- UC-007-FA-002: Exportar seleção

**Fluxos de Exceção:**
- UC-007-FE-001: Limite de registros excedido
- UC-007-FE-002: Geometrias inválidas
- UC-007-FE-003: Erro de reprojeção

**Regras de Negócio:**
- RN-001: Limite máximo 10.000 registros por exportação prevenindo timeout e arquivos gigantes
- RN-002: URLs de download expiram após 24h exigindo nova exportação se necessário
- RN-003: Shapefile usa encoding UTF-8 com BOM evitando corrupção de acentos (não CP1252 legado)
- RN-004: GeoJSON sempre exportado em EPSG:4326 conforme especificação RFC 7946
- RN-005: Fotos e documentos anexados apenas para formato Shapefile em subpasta /fotos dentro do ZIP

**Rastreabilidade:**
- RF-197, RF-198, RF-199, RF-200, RF-201, RF-202, RF-207
- US-072, US-073

---

**Última atualização:** 2025-12-30
**Status do arquivo**: Review
