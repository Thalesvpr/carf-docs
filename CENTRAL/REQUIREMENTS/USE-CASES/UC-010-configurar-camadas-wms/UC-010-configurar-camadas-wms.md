---
modules: [GEOAPI, GEOWEB, REURBCAD]
epic: performance
---

# UC-010: Configurar Camadas WMS/WMTS

Caso de uso permitindo ADMIN com permissão geoservices.create adicionar servidores WMS (Web Map Service) e WMTS (Web Map Tile Service) externos como camadas base customizadas no mapa do sistema integrando fontes governamentais abertas (IBGE INDE INPE estaduais municipais) ou comerciais (Google Earth Engine Mapbox Satellite) fornecendo contexto geográfico visual como ortofotos imagens de satélite mapas topográficos limites administrativos zoneamento urbano áreas de risco facilitando análise espacial e tomada de decisão em processos de regularização fundiária após autenticação e disponibilidade de URL de servidor compatível com padrões OGC, onde fluxo principal inicia com acesso ao menu Configurações submenu Camadas de Mapa exibindo tela de gerenciamento listando todas camadas configuradas do tenant agrupadas por tipo (Basemaps padrão OSM Mapbox, WMS customizados, WMTS externos) mostrando colunas nome tipo URL status ativo/inativo ações editar deletar, ADMIN clica botão + Adicionar Camada WMS no canto superior direito abrindo formulário modal estruturado com campos obrigatórios incluindo input text Nome da Camada para label exibido no frontend (ex: "Ortofotos IBGE 2022", "Limites Municipais INDE"), radio buttons Tipo selecionando WMS (raster dinâmico gerado sob demanda permitindo customização de estilos mas mais lento) ou WMTS (tiles pré-renderizados estáticos mais rápidos porém fixos), input text URL do Servidor aceitando endpoint completo do serviço GetCapabilities (ex: https://geoservicos.ibge.gov.br/geoserver/wms, http://www.geoservicos.inde.gov.br/geoserver/wms), dropdown Versão listando 1.1.1 e 1.3.0 para WMS ou 1.0.0 para WMTS conforme especificações OGC suportadas, ADMIN preenche URL copiando de fonte confiável e clica botão Testar Conexão disparando validação prévia antes de salvar, sistema executa request HTTP GET síncrono para endpoint GetCapabilities construindo query string SERVICE=WMS&REQUEST=GetCapabilities&VERSION=1.3.0 ou SERVICE=WMTS&REQUEST=GetCapabilities conforme tipo selecionado com timeout 10 segundos, servidor externo responde XML estruturado conforme schema OGC contendo metadados do serviço incluindo título resumo contact information e lista de layers disponíveis cada um com Name Title Abstract BoundingBox SRS suportados Styles, sistema parseia XML usando biblioteca xml2js ou fast-xml-parser extraindo tags Layer iterando elementos filhos construindo array de objetos com propriedades name title abstract bbox, exibe lista de layers disponíveis no servidor renderizando cards ou tabela com checkboxes permitindo seleção múltipla mostrando Layer Name em negrito e Abstract como descrição auxiliar facilitando identificação do layer correto (servidores WMS tipicamente expõem dezenas de layers diferentes), ADMIN marca checkbox do layer desejado (ex: layer name="CCAR:BC250_Limite_Municipio_A" title="Limites Municipais 1:250.000") podendo selecionar múltiplos se necessário criando múltiplas configurações simultaneamente, formulário expande exibindo configurações adicionais por layer selecionado incluindo slider Opacidade 0-100% controlando transparência da camada sobreposta permitendo ver features do sistema abaixo sem ocultar completamente contexto (típico 60-80% para ortofotos), input number Ordem de Renderização (z-index) definindo empilhamento vertical das camadas no mapa onde valores menores renderizam primeiro embaixo (base=0, WMS=100-500, features sistema=1000+), checkbox Visível por Padrão marcando se camada aparece ativa automaticamente ao carregar mapa ou fica disponível mas desativada esperando usuário habilitar manualmente via layer control, input text Atribuição informando créditos obrigatórios a exibir conforme licença da fonte (ex: "© IBGE 2022", "Fonte: INDE") respeitando termos de uso, ADMIN ajusta configurações definindo opacidade 70% z-index 200 visível por padrão true atribuição conforme documentação da fonte e clica Salvar executando validação verificando URL não vazia e bem formada via regex, GetCapabilities retornou HTTP 200 com XML válido parseável, layer name selecionado existe na lista retornada pelo servidor evitando salvar referência inexistente, se validação passa sistema cria registro em tabela geoservices inserindo tenant_id name type url version layer_name opacity z_index visible_default attribution created_by=admin_id created_at=NOW(), exibe toast verde "Camada WMS adicionada com sucesso" e fecha modal retornando para listagem agora mostrando nova camada na tabela com status Ativo e ícone de mapa, frontend GEOWEB ao carregar aplicação executa GET /api/geoservices?tenant_id=$tenant buscando todas camadas configuradas do tenant recebendo JSON array com configurações completas, itera array filtrando visible_default=true e adiciona camada ao mapa usando MapLibre GL JS addSource criando source tipo raster com tiles array contendo template URL de GetMap para WMS construindo {url}?SERVICE=WMS&REQUEST=GetMap&VERSION={version}&LAYERS={layer_name}&BBOX={bbox}&WIDTH=256&HEIGHT=256&SRS=EPSG:3857&FORMAT=image/png ou tileUrl para WMTS seguindo padrão RESTful, adiciona layer tipo raster referenciando source com propriedades opacity e paint configuradas conforme banco, camada renderiza no mapa exibindo tiles carregados dinamicamente conforme viewport do usuário panning e zoom ativando requests sob demanda ao servidor externo, usuário vê contexto geográfico enriquecido podendo navegar mapa com ortofoto de fundo identificando visualmente localização de unidades habitacionais em relação a ruas rios vegetação construções adjacentes facilitando validação de cadastros conferência de geometrias e planejamento de visitas de campo. Fluxos alternativos incluem adicionar WMTS com campos TileMatrixSet e Format específicos (UC-010-FA-001) e usar proxy para evitar bloqueios CORS (UC-010-FA-002). Fluxos de exceção cobrem GetCapabilities falhando por timeout ou URL incorreta (UC-010-FE-001), XML inválido não parseável (UC-010-FE-002), servidor sem layers disponíveis (UC-010-FE-003), e erro ao renderizar camada no frontend (UC-010-FE-004).

**Fluxos Alternativos:**
- UC-010-FA-001: Adicionar WMTS
- UC-010-FA-002: Proxy de WMS

**Fluxos de Exceção:**
- UC-010-FE-001: GetCapabilities falha
- UC-010-FE-002: XML inválido
- UC-010-FE-003: Layer não encontrado
- UC-010-FE-004: Erro ao renderizar (frontend)

**Regras de Negócio:**
- RN-001: Apenas ADMIN pode adicionar editar ou deletar camadas WMS/WMTS (ANALYST e MANAGER readonly)
- RN-002: URL deve retornar GetCapabilities válido parseável antes de salvar
- RN-003: Camadas configuradas são globais por tenant visíveis para todos usuários compartilhando configuração
- RN-004: Ordem de renderização fixa: basemaps (z=0-99) → WMS (z=100-999) → features sistema (z=1000+)
- RN-005: Cache de tiles WMS habilitado por 24h se proxy usado economizando requests ao servidor externo

**Rastreabilidade:**
- RF-212, RF-213, RF-214, RF-215, RF-216, RF-221
- US-064, US-119

---

**Última atualização:** 2025-12-30
