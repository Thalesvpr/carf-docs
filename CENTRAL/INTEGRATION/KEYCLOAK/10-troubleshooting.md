# Troubleshooting

**Erro: invalid_grant "Token is not active"** → token expirado, fazer refresh com grant_type=refresh_token ou redirecionar pro login se refresh_token também expirou. **Erro: invalid_client "Invalid client credentials"** → client_secret errado ou client_id não existe, verificar .env e realm config. **Erro: invalid_redirect_uri** → redirectUri não está na lista de Valid Redirect URIs do client, adicionar no Keycloak admin console, lembrar que precisa match exato incluindo trailing slash. **Erro: CORS "No 'Access-Control-Allow-Origin' header"** → adicionar origem no Web Origins do client ou usar [+] pra inherit de redirectUris, backend precisa CORS middleware antes de auth middleware. **Erro: PKCE code_challenge mismatch** → code_verifier enviado no POST /token é diferente do usado pra gerar code_challenge no GET /auth, verificar se está usando mesma string, SHA256 correto, base64url encoding sem padding. **Erro: Connection refused localhost:8080** → Keycloak não subiu ou porta errada, `docker-compose ps` verifica status, `docker-compose logs keycloak` vê erro startup, esperar 90s pra healthcheck passed. **Erro: Realm not found** → importação falhou, verificar que `realm-export.json` está montado em `/opt/keycloak/data/import/` e comando usa `--import-realm`, reimportar manualmente via Admin Console → Add Realm → Import JSON. **Erro: User attribute not in token** → protocol mapper não configurado, adicionar mapper oidc-usermodel-attribute-mapper mapeando user.attribute pra claim.name. **Erro: RLS policy não filtra** → `app.tenant_id` não foi setado, verificar que middleware TenantMiddleware executa ANTES de DbContext usar connection, checar que claim `tenant_id` existe no JWT, testar com `SELECT current_setting('app.tenant_id', true)`. **Erro: Session expired rapidamente** → SSO Session Idle Timeout muito curto, aumentar em Realm Settings → Tokens → SSO Session Idle/Max, frontend precisa fazer keepalive com updateToken periodicamente. **Erro: Tenant switcher não funciona** → backend não valida allowed_tenants ou Admin API falha, logs mostram Forbidden ou Keycloak Admin API 401, verificar que service account tem permissões manage-users no realm-management client.

---

**Última atualização:** 2026-01-09
**Status do arquivo**: Pronto
