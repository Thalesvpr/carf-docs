# Testes de Integração Keycloak

Testar fluxos OAuth2 end-to-end com Testcontainers (Keycloak + PostgreSQL em containers Docker durante testes) ou Keycloak standalone em test profile. PKCE flow test: gera code_verifier random, calcula code_challenge=SHA256(code_verifier), GET /auth com code_challenge retorna authorization code, POST /token com code+code_verifier retorna access_token+id_token+refresh_token, valida que JWT contém claims corretos (sub, email, tenant_id, allowed_tenants, roles), decode token e verifica signature usando JWKS public key. Client credentials test: POST /token com client_id=geogis + client_secret + grant_type=client_credentials retorna access_token sem user context, token contém azp=geogis e não tem email/tenant_id. Token refresh test: usa refresh_token pra obter novo access_token, verifica que access_token antigo não funciona mais (revogado), testa que após max reuse (0) o mesmo refresh_token não pode ser reusado. Bearer token validation test: backend recebe access_token no header Authorization, valida signature e claims, extrai tenant_id e seta no PostgreSQL, query retorna apenas dados do tenant correto. Tenant switch test: usuário com allowed_tenants=["a","b"] faz switch pra tenant "b", backend atualiza current_tenant no Keycloak, novo token tem tenant_id="b", RLS filtra dados do tenant "b". Logout test: POST /logout invalida sessão SSO e refresh_token, tentativa de refresh retorna invalid_grant. Brute force test: 5 logins falhados consecutivos bloqueiam conta por 15min, 6º login retorna account_temporarily_disabled. Token expiration test: access_token com exp passado retorna 401 Unauthorized, frontend detecta e faz refresh automático. CORS test: request de origem http://localhost:3000 com client configurado webOrigins=[+] retorna Access-Control-Allow-Origin header, origem não autorizada retorna CORS error. Tools: usar RestAssured ou Playwright pra testes E2E, Postman Collections pra smoke tests manuais, Newman pra rodar Postman em CI/CD, WireMock pra mockar Keycloak em unit tests se necessário.

---

**Última atualização:** 2026-01-09
