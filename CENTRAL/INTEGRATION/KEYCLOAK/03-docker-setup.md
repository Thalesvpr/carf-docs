# Docker Setup Keycloak

`docker-compose.yml` sobe Keycloak 24.0.0 + PostgreSQL 16 com volume persistente `keycloak-db-data`, monta `./realm-export.json:/opt/keycloak/data/import/realm-export.json` e usa comando `start-dev --import-realm` pra importar automaticamente no startup. Portas: 8080 (HTTP), 8443 (HTTPS). Healthcheck: `curl -f http://localhost:8080/health/ready` a cada 30s, start_period 90s. `.env` define KEYCLOAK_ADMIN=admin, KEYCLOAK_ADMIN_PASSWORD=admin, POSTGRES_DB=keycloak, POSTGRES_USER=keycloak, POSTGRES_PASSWORD=keycloak, KC_DB_URL=jdbc:postgresql://keycloak-db:5432/keycloak. Usar `docker-compose up -d` pra subir, `docker-compose logs -f keycloak` pra ver logs, `docker-compose down` pra parar (mantém volumes), `docker-compose down -v` pra deletar tudo incluindo banco (cuidado). Acessar admin console http://localhost:8080 com admin/admin, realm "carf" já importado com 6 clients configurados. Criar usuário de teste: Users → Add user → username, email → Credentials tab → set password (temporary=OFF) → Role Mappings → analyst → Attributes → adicionar `tenants` = `["prefeitura-teste"]` e `current_tenant` = `prefeitura-teste`. Testar token: `curl -X POST "http://localhost:8080/realms/carf/protocol/openid-connect/token" -d "client_id=geoweb" -d "grant_type=password" -d "username=teste" -d "password=senha123" | jq '.access_token' | cut -d'.' -f2 | base64 -d | jq` verifica se tem `tenant_id` e `allowed_tenants`. Backup: `docker-compose exec keycloak-db pg_dump -U keycloak keycloak > backup.sql`, restore: `docker-compose exec -T keycloak-db psql -U keycloak keycloak < backup.sql`. Produção: usar `start` ao invés de `start-dev`, configurar SSL/TLS com KC_HTTPS_CERTIFICATE_FILE, não usar senhas padrão, habilitar backups automáticos, configurar proxy reverso Nginx/Traefik na frente.

---

**Última atualização:** 2026-01-09
**Status do arquivo**: Review
