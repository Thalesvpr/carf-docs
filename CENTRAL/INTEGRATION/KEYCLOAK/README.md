# KEYCLOAK - Integração de Autenticação

Keycloak provê autenticação centralizada OAuth2/OIDC para todo ecossistema CARF usando realm único "carf" com multi-tenancy dinâmico via atributos de usuário mapeados como claims JWT permitindo isolamento de dados por município através de integração com PostgreSQL Row-Level Security. Sistema implementa Single Sign-On unificado entre seis aplicações (GEOWEB portal web, REURBCAD mobile field collection, GEOAPI backend REST, GEOGIS plugin QGIS desktop, WEBDOCS site documentação, ADMIN console administrativo) onde usuário autentica uma única vez obtendo sessão válida compartilhada entre todas aplicações eliminando necessidade de múltiplos logins melhorando experiência e segurança. Realm "carf" configura seis clients OAuth2/OIDC adaptados para diferentes tipos de aplicação sendo clients públicos com PKCE (Proof Key for Code Exchange) para SPAs e mobile apps prevenindo ataques interceptação sem necessidade de client secret armazenado em frontend, clients confidenciais bearer-only para backends validando tokens sem redirecionar usuário, e clients service account com client credentials flow para integrações máquina-para-máquina como plugins GIS executando operações automatizadas batch processing. Autorização implementa cinco roles RBAC hierárquicos (super-admin gerencia todos tenants com poderes totais, admin gerencia próprio tenant criando usuários e configurações, manager coordena equipes e aprova unidades, analyst valida dados técnicos executando análises GIS, field-collector coleta dados em campo via mobile) com protocol mappers customizados injetando claims tenant_id e allowed_tenants em tokens JWT permitindo backend extrair contexto sem consultar banco de dados adicionando tenant_id como atributo de sessão PostgreSQL via SET app.tenant_id ativando RLS policies que filtram automaticamente todas queries isolando dados por município sem código adicional em aplicações garantindo multi-tenancy seguro por design. Customizações específicas CARF incluem temas visuais personalizados para páginas login account email traduzidos português brasileiro com identidade visual municipal, validação client-side de CPF e CNPJ em formulários de cadastro usando algoritmos verificadores implementados em JavaScript validando dígitos antes de submeter prevenindo erros de digitação, e integração com APIs municipais externas para verificação de vínculos funcionais servidores públicos autorizados a acessar sistema conforme policies estabelecidas em [Security](../../SECURITY/README.md) garantindo apenas usuários legítimos obtêm credenciais.

Documentação técnica completa organiza conceitos fundamentais em [architecture](./01-architecture.md) detalhando flows OAuth2/OIDC (Authorization Code, Client Credentials, Refresh Token) com sequence diagrams mostrando interação entre browser aplicação Keycloak e resource server, [realm configuration](./02-realm-configuration.md) especificando configurações do realm "carf" incluindo token lifetimes (access token 5 minutos, refresh token 30 dias, SSO session 8 horas), [docker setup](./03-docker-setup.md) provendo ambiente desenvolvimento local com docker-compose levantando Keycloak PostgreSQL e mock SMTP server permitindo testes de fluxos completos sem infraestrutura complexa, [multi-tenancy](./04-multi-tenancy.md) descrevendo estratégia de isolamento via user attributes mapeados como JWT claims extraídos por middleware backend configurando sessão PostgreSQL, e [client configurations](./05-client-configurations.md) listando seis clients pré-configurados com settings específicos (geoweb-client public com PKCE redirects http://localhost:3000 e https://geoweb.carf.gov.br, reurbcad-client public mobile com custom URL scheme carf://callback, geoapi-client bearer-only sem redirect URIs validando apenas tokens, geogis-client confidential com client secret para service account operations, webdocs-client public read-only, admin-client public PKCE com role restrictions super-admin/admin). Documentação operacional cobre [RBAC permissions](./06-rbac-permissions.md) mapeando roles para permissions granulares create/read/update/delete em resources específicos (units holders communities teams) usando matriz de autorização consultável, [token management](./07-token-management.md) explicando ciclo de vida de tokens desde geração até expiração incluindo estratégias refresh automático em frontends antes de expirar prevenindo interrupções de sessão, [production deployment](./08-production-deployment.md) detalhando setup high-availability cluster Keycloak com PostgreSQL backend replicado load balancer distribuindo requests e cache Infinispan sincronizado entre nodes, [security best practices](./09-security-best-practices.md) recomendando rotação periódica de client secrets habilitação HTTPS obrigatório configuração rate limiting proteção contra brute force e auditoria completa de eventos autenticação, e [troubleshooting](./10-troubleshooting.md) diagnosticando problemas comuns como invalid token signature expirado audience incorreto CORS misconfiguration e RLS policies bloqueando queries inesperadamente.

Runbooks operacionais proveem guias passo-a-passo para administradores executarem tarefas críticas incluindo [criar usuário](./runbooks/01-create-user.md) via Admin Console atribuindo roles tenant e enviando email boas-vindas com instruções primeiro acesso, [criar tenant](./runbooks/02-create-tenant.md) adicionando novo município ao sistema configurando attributes necessários para RLS e atribuindo primeiro admin municipal, [rotacionar secrets](./runbooks/03-rotate-secrets.md) gerando novos client secrets atualizando configurações de aplicações sem downtime seguindo zero-downtime deployment pattern, [troubleshoot autenticação](./runbooks/04-troubleshoot-auth.md) diagnosticando falhas login usando logs Keycloak identificando configurações incorretas clients desabilitados ou problemas rede, [backup e restore](./runbooks/05-backup-restore.md) exportando realm configuration completo via Admin Console ou REST API permitindo disaster recovery rápido restaurando configurações em novo ambiente, e [monitoramento](./runbooks/06-monitoring.md) configurando health checks métricas Prometheus dashboards Grafana alertas eventos críticos como falhas autenticação picos de latência ou indisponibilidade serviço. Implementações técnicas específicas de integração Keycloak em cada aplicação CARF (setup de AuthContext providers React, configuração de middleware ASP.NET Core JWT Bearer authentication, inicialização de KeycloakOpenID Python, storage de tokens em secure storage mobile) são documentadas em diretórios DOCS de cada projeto referenciando conceitos estabelecidos neste diretório CENTRAL/INTEGRATION/KEYCLOAK como fonte única de verdade para padrões de autenticação e autorização cross-project evitando duplicação e garantindo consistência entre implementações frontend backend mobile e desktop.

---

**Última atualização:** 2026-01-11
