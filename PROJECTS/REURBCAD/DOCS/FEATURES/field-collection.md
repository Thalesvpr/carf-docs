# Field Collection - Coleta em Campo

Feature de coleta dados em campo implementada como formulário wizard multi-step React Native permitindo field collectors cadastrarem unidades habitacionais ocupações durante levantamento técnico áreas sem internet através de telas UnitFormScreen usando Expo Router stack navigation com params unitId para edição ou null para criação nova, formulário dividido em steps BasicInfo AddressInfo AreaMeasurement Geolocation PhotoCapture cada step renderizado como screen separada com botões Próximo Voltar validações inline impedindo avanço se campos obrigatórios vazios ou inválidos, componentes principais FormStep1BasicInfo inputs controlled via React Hook Form useForm hook campos nome tipo ocupação status comunidade_id dropdown CaracterizacaoOcupacao enum CONSOLIDADA PRECARIA RISCO validando obrigatoriedade trim não vazio, FormStep2Address inputs logradouro número complemento bairro CEP validando formato CEP 8 dígitos via Zod regex pattern offering autocomplete via CEP API quando online fallback manual input offline, FormStep3Area input numérico área metros quadrados validando min 10 max 10000 reasonable bounds calculadora built-in permitindo field collector inserir dimensões largura comprimento auto-calculating área total, FormStep4Geolocation MapView React Native Maps mostrando marker draggable na posição GPS atual obtida via Expo Location getCurrentPositionAsync com accuracy high timeout 10s botão Obter Localização Atual refreshing coords se user moveu botão Marcar Manualmente permitindo drag marker se GPS impreciso, FormStep5Photos FlatList exibindo thumbnails captured photos com botão Adicionar Foto abrindo BottomSheet options Câmera ou Galeria usando Expo Camera launchCameraAsync ou Image Picker launchImageLibraryAsync compressing images via expo-image-manipulator resize 1920x1080 quality 0.8 reduzindo size antes save persistindo URIs local filesystem Expo FileSystem documentDirectory storage references WatermelonDB photos collection.

Validações implementadas via Zod schema unitSchema validando name obrigatório string trim min 3 max 200, address obrigatório nested object com street number neighborhood city state CEP validando formato patterns, area obrigatório number min 10 max 10000 reasonable bounds evitando typos absurdos 100000 m2 para residência, geolocation obrigatório object latitude longitude validando formato decimal degrees range -90 to 90 latitude -180 to 180 longitude accuracy meters optional metadata, photos opcional array de URI strings validando formato file path max 10 photos limit evitando storage overflow device, community_id obrigatório UUID validando existência via lookup WatermelonDB communities collection checando ID presente antes submit, caracterizacao obrigatório enum validando against allowed values CONSOLIDADA PRECARIA RISCO typed literal Zod, validação client-side executada onChange para cada field mostrando error messages inline via FormErrorMessage component abaixo input red text icon warning, validação submit executada ao final wizard before persist checando all steps valid re-validating entire schema caso user navegou back modificou fields anteriores garantindo consistency.

API integration via offline-first pattern persistindo localmente WatermelonDB units collection via database.write async action criando Unit model instance com fields preenchidos form setando _status pending_create indicando record novo aguardando sync, queueing sync operation em sync_queue collection inserindo record com entity_type unit entity_id operation create payload JSON serialized form data timestamp criado ordem processing, quando NetInfo detecta conexão online via addEventListener change event triggering syncData function iterando sync_queue processing cada record sequentially chamando POST /api/units com payload deserializado Authorization Bearer header access token obtido AuthManager, se request success 201 Created recebendo server-generated unitId atualizando local record com server ID setando _status synced removendo da sync_queue, se request fail 4xx 5xx error capturando response incrementando retry_count se < 3 mantendo em queue para retry posterior com exponential backoff delay, se 409 Conflict detectando duplicate via server validation oferecendo merge options user escolhe keep local keep server merge fields, se network timeout mantendo em queue retry automático próxima sync attempt, background sync via Expo Background Fetch registerTaskAsync executando periodic sync attempts mesmo app background garantindo dados enviados logo conexão disponível field collector não precisa manual intervention.

Domain model mapeando CENTRAL Unit entity para WatermelonDB @model class Unit extending Model com @field name tipo string nullable false, @field address tipo string JSON serialized object nested, @field area tipo number, @children photos via @children('photos') relation one-to-many photos collection, @field geolocation tipo string JSON serialized coords, @field community_id foreign key relation @relation('community', 'community_id') many-to-one communities, @field _status enum local synced pending_create pending_update pending_delete tracking sync state, @date created_at updated_at timestamps auto-managed via prepareCreate prepareUpdate hooks, implementação UC-004 requirements incluindo wizard multi-step formulário mobile touch-optimized validações inline feedback, captura geolocalização GPS automática manual fallback marker draggable, captura fotografias câmera galeria compressão storage local, persistência offline WatermelonDB zero data loss, sincronização automática background queue-based retry logic, implementação UC-001 incluindo cadastro unidade campos obrigatórios validações CPF área endereço relacionamento titular holder_id foreign key community_id atribuição geolocation GPS photos evidências rastreando RF-005 RF-006 cadastro coleta campo mobile offline.

---

**Última atualização:** 2026-01-11
