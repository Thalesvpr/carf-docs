# Offline Sync - Sincronização

Feature de sincronização offline implementada via arquitetura queue-based bidirectional sync permitindo field collectors trabalharem semanas offline acumulando changes localmente sincronizando automaticamente quando conexão disponível através de SyncManager service singleton gerenciando sync lifecycle pull server changes push local changes conflict resolution retry logic usando WatermelonDB sync adapter configurado com pullChanges pushChanges methods conectando GEOAPI sync endpoints GET /api/sync/changes POST /api/sync/push, componentes principais SyncQueueModel WatermelonDB collection armazenando pending operations com fields entity_type unit holder photo operation_type create update delete payload JSON serialized timestamp retry_count status pending processing failed, SyncStatusIndicator UI component mostrando badge sync state idle syncing conflicts_pending error com icon color green yellow red pulsating animation durante sync, SyncSettingsScreen permitindo user configurar auto-sync enabled WiFi-only cellular-allowed sync_interval minutes background_sync enabled, ConflictResolutionDialog modal exibindo conflicting records server version vs local version com options Keep Local Keep Server Merge Fields side-by-side comparison highlighting differences field-by-field, SyncLogScreen listando historical sync attempts timestamps records synced failures errors facilitando debugging troubleshooting field issues.

Validações implementadas verificando network connectivity via NetInfo antes iniciar sync abortando se offline mostrando toast Network unavailable guardando battery evitando failed attempts, checking authentication token validade via AuthManager.getAccessToken garantindo access token não expired refresh se necessário antes sync requests evitando 401 errors midway sync, validating payload integrity antes push verificando required fields present geolocation valid CPF format correct evitando server rejections devido invalid data, checking available storage space antes pull via Expo FileSystem getTotalDiskCapacityAsync getFreeDiskStorageAsync alertando user se < 100MB free oferecendo clear cache old photos liberando space, rate limiting sync requests max 50 records per batch evitando timeout backend overload splitting large queues múltiplos batches sequential processing progress indicator updating, conflict detection comparing updated_at timestamps server record vs local se server newer e local modified since last sync marking conflict requiring resolution usuário escolhe strategy, duplicate detection via unique constraints checking server response 409 Conflict indicando record já existe oferecendo merge ou skip.

API integration via sync adapter implementando pullChanges async function calling GET /api/sync/changes params last_sync_timestamp tenant_id retornando JSON created_records updated_records deleted_records arrays cada contendo full record data, iterando arrays aplicando changes localmente via database.batch write criando updating deletando records WatermelonDB preservando referential integrity foreign keys, salvando new last_sync_timestamp para próximo pull incremental apenas changes since last sync reduzindo payload bandwidth, implementando pushChanges function iterando sync_queue collection filtrando status pending building batch payload array operations cada com entity_type entity_id operation payload calling POST /api/sync/push body batch array Authorization header, backend processa batch sequentially validando cada operation aplicando database executando business rules returning results array com success boolean server_id se created error_message se failed, client itera results atualizando sync_queue marcando successful operations status synced removendo queue updating local records server IDs, failed operations incrementando retry_count mantendo queue se retry_count < 3 senão marcando status failed requiring manual intervention, conflict resolution oferecendo strategies last-write-wins server record sempre vence ignorando local changes, client-wins local record vence server updated com local data via force push flag, manual user escolhe field-by-field via ConflictResolutionDialog constructing merged record combining selected fields, three-way merge comparando base version common ancestor com server local versions detecting concurrent changes merging non-conflicting fields prompting user apenas conflicting fields.

Domain model sync adapter configurado WatermelonDB synchronize function recebendo database instance pullChanges pushChanges functions migration strategy set migrate indicando schema version server deve enviar formato esperado client, local timestamp tracking via sync_metadata collection singleton record storing last_sync_timestamp last_sync_status last_sync_error enabling incremental sync resumable após failures, entity versioning via version field integer incrementado cada update detectando stale updates preventing lost updates concurrent modifications, soft delete pattern deleted_at timestamp nullable preservando records após delete permitindo sync delete operations downstream clients tombstone records cleaning up após retention period, conflict tracking via conflicts collection storing unresolved conflicts entity_type entity_id local_data server_data timestamp awaiting user resolution blocking entity sync até conflict resolved, implementação UC-005 requirements incluindo sincronização bidirecional push local pull server changes, detecção automática conexão via NetInfo triggering sync, sync background via Expo Background Fetch periodic attempts, conflict resolution strategies configuráveis last-write-wins manual, retry logic exponential backoff max attempts, progress tracking UI feedback sync status, error handling logging failures debugging, relacionamento requirements implementando RF-020 RF-021 sync offline queue conflict resolution garantindo field collectors produtivos zero data loss eventual consistency.

---

**Última atualização:** 2026-01-11
