# AccessDeniedException


Exception indicando que usuário autenticado não tem permissão para executar operação solicitada mapeando para HTTP 403 Forbidden diferenciando de 401 Unauthorized onde usuário não está autenticado permitindo mensagens claras sobre falta de autorização. Herda de 00-domain-exception sobrescrevendo HttpStatusCode para 403. Propriedades específicas incluem RequiredPermission (string permissão necessária tipo "units.delete" "legitimation.approve" indicando o que faltou), RequiredRole (17-role value object nullable papel mínimo requerido tipo MANAGER ADMIN), Resource (string recurso sendo acessado tipo "Unit #123" "Community ABC"), UserId (Guid AccountId do usuário que tentou operação), e Reason (string motivo detalhado tipo "Usuário não pertence à equipe autorizada para esta comunidade" "Apenas MANAGER pode aprovar legitimações"). Construtores incluem AccessDeniedException(string requiredPermission) simples indicando permissão faltante, AccessDeniedException(Role requiredRole) quando baseado em papel, AccessDeniedException(string message string requiredPermission string resource) completo contextual, e factory methods ForPermission(permission) ForRole(role) ForCommunityAccess(communityId) convenientes. Métodos GetDetailedMessage() gerando mensagem contextual rica incluindo o que usuário tentou fazer o que faltou e como obter acesso, e ShouldLogAsSecurityEvent() retornando true se tentativa parece suspeita tipo acesso cross-tenant ou escalação de privilégio indicando necessidade de alerta de segurança. Lançada em command handlers após verificação de permissões tipo if !_currentUser.HasRole(Role.MANAGER) throw new AccessDeniedException.ForRole(Role.MANAGER) antes de executar Unit.Approve(), quando ICommunityAccessChecker.CanEdit retorna false lançar AccessDeniedException.ForCommunityAccess indicando sem permissão para comunidade específica, quando usuário tenta deletar Unit criada por outro sem permissão admin, quando FIELD_AGENT tenta acessar funcionalidade restrita a ANALYST, e quando tenant tenta acessar recurso de outro tenant indicando falha grave de isolamento. Também lançada em domain services quando regra de ownership viola tipo apenas criador de LegitimationRequest pode cancelar verificando RequesterId == _currentUser.AccountId caso contrário lançar AccessDeniedException com reason "Apenas o solicitante pode cancelar o processo", Team.RemoveMember validando que apenas LEADER pode remover membros, e operations sensíveis tipo emitir certidão requerendo múltiplas validações de papel e permissões específicas. Capturada por middleware retornando ProblemDetails com status 403 title "Forbidden" detail explicando permissão ou papel necessário sem revelar estrutura interna de autorizações evitando information disclosure, logada como Warning incluindo userId resource requiredPermission permitindo auditoria de tentativas de acesso não autorizado identificando usuários mal-intencionados ou mal configurados, diferenciada de 401 onde middleware retorna WWW-Authenticate header redirecting para login enquanto 403 indica autenticado mas sem permissão não adianta reautenticar, integra com frontend que intercepta 403 exibindo modal explicativo tipo "Você não tem permissão para esta ação. Entre em contato com seu coordenador para solicitar acesso" com botão para abrir ticket de suporte, e fornece dados para dashboard de segurança rastreando recursos mais acessados indevidamente indicando necessidade de melhor comunicação de permissões ou possível ataque.

---

**Última atualização:** 2026-01-12
**Status do arquivo**: Pronto
