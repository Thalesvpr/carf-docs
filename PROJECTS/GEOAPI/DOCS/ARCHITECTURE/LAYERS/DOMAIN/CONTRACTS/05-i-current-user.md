# ICurrentUser


Interface fornecendo dados do usuário autenticado atual extraídos de JWT token permitindo acesso a AccountId TenantId Role e claims sem depender diretamente de HttpContext mantendo domain e application layers independentes de infraestrutura web. Propriedades principais incluem AccountId retornando Guid do usuário autenticado extraído de claim "sub" ou "account_id", TenantId retornando Guid do cliente atual extraído de claim "tenant_id" redundante com ITenantProvider mas conveniente, Email retornando string email do usuário, Name retornando string nome completo, Role retornando Role value object papel do usuário SUPER_ADMIN ADMIN MANAGER ANALYST FIELD_AGENT, e IsAuthenticated retornando bool verificando se usuário está autenticado ou request anônimo. Métodos adicionais incluem HasRole(Role role) verificando se usuário tem papel específico útil para guards de autorização, HasPermission(string permission) verificando se tem permissão granular tipo "units.delete" consultando roles e permissions associados, GetClaim(string claimType) extraindo claim customizado do token permitindo extensibilidade, e IsInTeam(Guid teamId) verificando se usuário pertence a equipe específica consultando TeamMember. Implementada por HttpCurrentUser em aplicações web extraindo claims de IHttpContextAccessor.HttpContext.User parseando valores e cacheando em propriedades da classe evitando múltiplas extrações, BackgroundJobCurrentUser em jobs onde usuário é passado como parâmetro do job simulando contexto autenticado, e AnonymousCurrentUser retornando valores null ou false para todas propriedades usado em testes ou operações públicas. Usada em command handlers validando permissões antes de executar operação tipo if !_currentUser.HasRole(Role.MANAGER) throw AccessDeniedException, em repositories filtrando queries por acesso do usuário tipo GetAuthorizedCommunities retornando apenas Communities onde usuário tem CommunityAuthorization, em audit logging populando AccountId automaticamente em AuditLog sem passar manualmente, em domain services verificando ownership tipo apenas criador de LegitimationRequest pode cancelar verificando RequesterId == _currentUser.AccountId, e em eventos populando metadados tipo UnitCreatedEvent contendo CreatedBy extraído de currentUser. Registrada como scoped em DI garantindo mesma instância durante request mas diferente entre requests concorrentes, integra com Keycloak onde claims no token JWT são mapeados para propriedades da interface mantendo sincronização, e suporta impersonation onde admin pode assumir identidade de outro usuário temporariamente para suporte sobrescrevendo AccountId mantendo audit trail de quem realmente executou ação.

---

**Última atualização:** 2026-01-12
