GEOAPI integra com Keycloak como bearer-only client que valida JWT tokens via middleware AddJwtBearer configurado com Authority apontando para http://localhost:8080/realms/carf e Audience=geoapi validando assinatura RS256 issuer audience e lifetime do token sem tolerância ClockSkew=Zero extraindo claims sub user id tenant_id tenant atual allowed_tenants array de tenants autorizados e realm_access.roles roles do usuário através de TokenValidationParameters com RoleClaimType configurado para mapear corretamente.

TenantMiddleware executa após UseAuthentication e UseAuthorization para setar SET LOCAL app.tenant_id = {tenantId} no PostgreSQL connection usando ExecuteSqlRawAsync permitindo que RLS policies filtrem automaticamente todas as queries por tenant sem código adicional nos repositórios garantindo isolamento completo dados municipais diferentes prevenindo vazamento acidental cross-tenant data leakage bugs esquecimento WHERE tenant_id cláusulas manual desenvolvedor.

Controllers usam [Authorize(Roles = "analyst,admin")] para controlar acesso por role e ClaimsPrincipalExtensions provê métodos helper como GetUserId() GetTenantId() GetAllowedTenants() e HasAnyRole() para facilitar acesso aos claims no código da aplicação evitando parsing manual string JSON arrays extraindo valores diretamente ClaimsPrincipal User.Claims simplificando lógica autorização validação permissions granulares resource-level access control.
