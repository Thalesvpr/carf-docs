Validar JWT tokens manualmente no GEOAPI útil para testes e debugging envolve primeiro entender que AddJwtBearer faz validação automática via middleware mas às vezes precisa validação adicional, por exemplo em SignalR hubs onde middleware não é executado então precisa validar manualmente no OnConnectedAsync, ou em background jobs/scheduled tasks onde não há HTTP context, ou em testes de integração onde quer testar lógica de autorização sem subir Keycloak real, validação manual requer primeiro obter public keys do Keycloak via HttpClient GET ao endpoint `http://localhost:8080/realms/carf/protocol/openid-connect/certs` que retorna JSON Web Key Set (JWKS) com array de keys cada uma contendo kid (key id), kty, use, alg, n (modulus), e (exponent), cachear essas keys por ~1 hora porque não mudam frequentemente, criar TokenValidationParameters com ValidIssuer=http://localhost:8080/realms/carf, ValidAudience=geoapi, IssuerSigningKeys=securityKeys (convertidas de JWKS), ValidateIssuerSigningKey=true, ValidateLifetime=true, ClockSkew=TimeSpan.Zero, usar JwtSecurityTokenHandler().ValidateToken(token, validationParameters, out SecurityToken validatedToken) que retorna ClaimsPrincipal se válido ou lança SecurityTokenException se inválido, extrair claims do ClaimsPrincipal da mesma forma que em controllers com FindFirst("claim_name"), em testes de integração criar tokens mock usando JwtSecurityTokenHandler().WriteToken(new JwtSecurityToken(issuer, audience, claims, expires, signingCredentials)) com SigningCredentials usando symmetric key compartilhada ou configurar Keycloak test container com Testcontainers library que sobe Keycloak em Docker durante testes, imports realm-export.json automaticamente, permite criar users programaticamente via Admin API, obter tokens reais via password grant, garantindo que testes validam comportamento real incluindo RLS policies e role checking, para debugging de tokens usar jwt.io para decodificar e visualizar header/payload/signature, verificar exp claim não expirou comparando com timestamp atual, verificar iss claim aponta para Keycloak correto, verificar aud claim contém geoapi, verificar tenant_id claim existe e tem valor correto, verificar realm_access.roles array contém roles esperadas, e se validação falha verificar logs do backend para ver erro específico (signature invalid, token expired, audience mismatch) e usar curl com token suspeito para reproduzir erro fora da aplicação isolando se problema é no token ou na configuração do backend.
