# Admin Integration - Integração Admin

Integração admin implementada proxy frontend ADMIN SPA para Keycloak Admin API permitindo super-admin e admin gerenciarem usuários roles attributes sem acessar Keycloak Admin Console diretamente através de 7 camadas segurança backend GEOAPI controllers wrapping Admin API client confidential secret endpoints protegidos authentication middleware validando JWT bearer token role permissions antes proxy calls garantindo apenas autorizados podem gerenciar usuários via AdminUsersController AdminRolesController AdminAttributesController expondo métodos create read update delete list search batch operations auditoria logging todas operações admin_actions table rastreabilidade compliance LGPD.

Backend implementation GEOAPI AdminUsersController classe Controller atributo [Authorize(Roles = "super-admin,admin")] impedindo access não autorizados, dependency injection KeycloakAdminClient library @keycloak/keycloak-admin-client ou Python python-keycloak conforme stack inicializado startup ConfigureServices registrando singleton instance configurado baseUrl realm clientId clientSecret obtido Azure Key Vault IConfiguration keyvault.GetSecret evitando hardcoded valores, endpoints GET /api/admin/users implementando ListUsers async method recebendo query params first max search email username calling kcAdmin.users.find params retornando UserRepresentation array total count pagination metadata, GET /api/admin/users/:id GetUser method param id UUID calling kcAdmin.users.findOne id retornando single user complete attributes roles groups sessions, POST /api/admin/users CreateUser method body CreateUserRequest DTO validating required fields username email firstName lastName validating unique username email via kcAdmin.users.find search filter calling kcAdmin.users.create payload returning userId setPassword via kcAdmin.users.resetPassword temporary false, PATCH /api/admin/users/:id UpdateUser method body partial fields calling kcAdmin.users.update id merging existing preserving não alterados, DELETE /api/admin/users/:id DeleteUser soft delete setando enabled false kcAdmin.users.update ou hard delete kcAdmin.users.del permanente.

Role management AdminRolesController endpoints POST /api/admin/users/:id/roles AddRoles method body roles array string validating role names exist realm via kcAdmin.roles.findOneByName calling kcAdmin.users.addRealmRoleMappings id roles array RoleMappingPayload, DELETE /api/admin/users/:id/roles RemoveRoles similar deleteRealmRoleMappings, GET /api/admin/roles ListRoles calling kcAdmin.roles.find retornando available realm roles client-specific roles Clients dropdown options frontend forms, attribute management PATCH /api/admin/users/:id/attributes UpdateAttributes method body attributes object key value pairs validating keys alphanumeric underscores values strings max length calling kcAdmin.users.update id attributes merging existing evitando overwrite não intencionais, GET /api/admin/users/:id/sessions GetSessions calling kcAdmin.users.listSessions id retornando active sessions array ipAddress lastAccess browser device metadata permitindo admin visualizar sessions ativas user force logout revoke sessions.

Security layers camada 1 authentication middleware validating JWT bearer token via AddJwtBearer ASP.NET Core checking signature issuer audience lifetime, camada 2 authorization [Authorize] attribute checking authenticated request.User.Identity.IsAuthenticated, camada 3 role-based [Authorize(Roles = "super-admin,admin")] filtering apenas roles autorizadas, camada 4 tenant isolation validating user tenant_id claim matches requested resource tenant filtering users list apenas mesmo tenant exceto super-admin all tenants, camada 5 audit logging middleware intercepting request response logging actor action timestamp resource_id details JSON admin_actions table rastreabilidade, camada 6 rate limiting throttling max 100 requests per minute per IP preventing abuse DoS attacks, camada 7 input validation sanitization DTO validations [Required] [EmailAddress] [StringLength] FluentValidation rules preventing injection attacks XSS SQL injection ensuring data integrity.

Frontend integration ADMIN React pages UsersListPage consuming GET /api/admin/users via TanStack Query useUsers hook caching pagination filtering, UserFormPage consuming POST PATCH endpoints useCreateUser useUpdateUser mutations optimistic updates cache invalidation, RolesAssignmentModal consuming role endpoints multi-select checkboxes applying changes batch operations, error handling backend catching KeycloakAdminClient exceptions AdminClientError parsing status code 409 Conflict username duplicate 400 Bad Request validation errors returning ProblemDetails RFC7807 format frontend displaying toast notifications inline form errors, permission checks frontend conditionally rendering create edit delete buttons based useAuth hasRole helper super-admin admin hiding unauthorized actions UX protection security enforcement backend sempre valida independente frontend pois client manipulável, testing integration tests MockKeycloakAdminClient stubbing responses verifying controller methods call kcAdmin correctly pass params handle errors, end-to-end tests Playwright Cypress navegando ADMIN app criando user verificando aparece listagem Keycloak Admin Console checking user created attributes roles correct.

---

**Última atualização:** 2026-01-11
