Customização de Realm no Keycloak envolve configurar clients OAuth2 com tipos public (geoweb/reurbcad/webdocs para SPAs e mobile apps usando Authorization Code + PKCE sem client secret, Valid Redirect URIs com wildcards como http://localhost:3000/* e https://app.carf.gov.br/*, Web Origins com CORS headers, Access Type = public), confidential (geoapi bearer-only para validação JWT server-side sem login redirect, Access Type = bearer-only), e confidential com secret (geogis/admin para M2M e server-side apps com Client Credentials grant, Access Type = confidential gerando client secret via Credentials tab), configurar roles realm-wide (field-collector, analyst, admin, super-admin com composite roles permitindo hierarquia onde admin herda analyst que herda field-collector) e client-specific roles (geoapi.read, geoapi.write, admin.users.create, admin.tenants.manage para granularidade fine-grained por aplicação).

Adicionar user attributes customizados (tenants como multi-valued string array ["prefeitura-a", "prefeitura-b"], current_tenant como single string "prefeitura-a", cpf como string "123.456.789-00" para validação adicional, role_prefixes para namespace isolation) acessíveis via User → Attributes tab ou bulk via Admin API POST /admin/realms/carf/users com JSON payload, criar protocol mappers para injetar claims no JWT access token via Client Scopes → profile → Add mapper → User Attribute com nome tenant_id, User Attribute = current_tenant, Token Claim Name = tenant_id, Claim JSON Type = String, Add to ID token OFF, Add to access token ON, Add to userinfo ON garantindo que todo access token contenha tenant_id extraído do user attribute current_tenant para RLS no backend.

Customizar authentication flows via Authentication → Flows copiando browser flow default e adicionando custom Authenticators como CPF Validator executando antes de Username Password Form ou OTP Conditional após password success implementando MFA condicional baseado em user attribute mfa_required, configurar password policies via Authentication → Password Policy definindo Minimum Length 12, Special Characters 1, Uppercase Characters 1, Digits 2, Not Username, Expire Password 90 days, Password History 5 impedindo reutilização, habilitar user registration via Realm Settings → Login → User registration ON com Required Actions incluindo Verify Email e Update Profile forçando confirmação de email antes de primeiro login, configurar email settings via Realm Settings → Email com SMTP host smtp.gmail.com port 587 TLS enabled, From display name "CARF Sistema" from address noreply@carf.gov.br, testável via Test connection enviando email de teste, personalizar realm display name via Realm Settings → General editando Display name para "CARF - Regularização Fundiária", HTML Display name com logo `<img src="..." /> CARF`.

Exportar configuração completa via Export → Export clients ON, Export groups ON, Export roles ON gerando realm-export.json commitado em `CENTRAL/INTEGRATION/KEYCLOAK/realm-export.json` para versionamento e import automático via docker-compose com volume mount `/opt/keycloak/data/import/realm.json` e command argument `--import-realm` permitindo infraestrutura como código reproduzível em dev/staging/prod sem clicks manuais no Admin Console, atualizar realm via partial import JSON via Admin Console → Partial import selecionando recursos específicos como clients ou roles evitando sobrescrever configurações divergentes entre ambientes, e aplicar changes via Keycloak Admin REST API programaticamente via curl ou scripts bash para CI/CD pipelines executando PUT /admin/realms/carf com bearer token obtido de admin-cli client usando username/password do admin permitindo GitOps workflow onde mudanças em realm-export.json triggeram pipeline que valida JSON schema, faz diff com produção, requer approval, e aplica via API com rollback automático em caso de falha detectada por smoke tests validando token issuance e user login.

---

**Última atualização:** 2026-01-15
**Status do arquivo**: Incompleto
Descrição: Falta título H1 na primeira linha.
