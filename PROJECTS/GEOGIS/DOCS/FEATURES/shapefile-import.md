# Shapefile Import - Importação

Feature de importação de shapefiles implementada no plugin QGIS Python permitindo usuários carregarem dados geoespaciais externos formato ESRI Shapefile contendo polígonos de unidades ocupações comunidades para integrar com sistema CARF através de dialog ShapefileImportDialog PyQt5 QDialog com wizard multi-step para selecionar arquivo validar geometrias mapear atributos preview importação, classe ImportProcessor gerenciando lógica de leitura parsing validation transformation upload usando PyQGIS OGR library QgsVectorLayer para ler shapefile extrair features geometries attributes, processing algorithms nativos QGIS via qgis.core.QgsProcessingAlgorithm para reprojeção dissolve clip simplify geometries, validation checks verificando CRS compatibilidade topology errors attribute completeness antes de upload, components principais incluem FileSelectWidget botão Browse para abrir QFileDialog filtrando extensões shp apenas mostrando selected file path label, AttributeMappingTable QTableWidget exibindo shapefile attributes como source columns com dropdowns target permitindo mapear para CENTRAL Unit fields name address area holder_name holder_cpf community_id, ValidationResultsWidget QTextEdit mostrando validation warnings errors contagem features válidas inválidas, PreviewMapWidget QgsMapCanvas embeded renderizando shapefile features com styling diferenciado para valid invalid features permitindo inspeção visual antes de import.

Validações implementadas verificando file existence accessibility via os.path.exists checking file readable permissions, shapefile completeness validando presença de companion files shp shx dbf prj required components sem os quais shapefile corrupto ou incompleto, geometry type validation checando layer.geometryType() equals QgsWkbTypes.PolygonGeometry rejeitando Point LineString incompatible com Unit entity que requer boundaries poligonais, CRS validation verificando layer.crs().isValid() e prompting user para selecionar CRS se missing PRJ file necessário para georeference corretamente features, topology validation rodando processing algorithm checkValidity para cada feature detectando self-intersections overlaps gaps invalid rings mostrando error list com feature IDs permitindo correção externa antes re-import, attribute validation verificando required fields presence name não null address válido area maior zero holder_cpf formato válido 11 dígitos usando validateCPF helper do @carf/tscore via Python equivalent regex pattern, duplicate detection comparando geometries com existing Units no banco via spatial query ST_Equals ou ST_Within threshold mostrando candidates duplicates alertando usuário evitando re-importação dados já cadastrados, encoding detection para DBF attributes usando chardet library auto-detecting Latin-1 UTF-8 CP1252 common encodings Brasil evitando mojibake caracteres especiais acentuação.

API integration via upload multipart form data POST /api/units/import endpoint enviando shapefile zipped contendo shp shx dbf prj files com attribute mapping JSON config especificando source to target field mappings e import options overwrite skip duplicates mode, ApiClient class usando requests library com files parameter construindo multipart/form-data payload adding Authorization Bearer header com access token obtido AuthManager, backend GEOAPI processa upload extrai shapefile via SharpZipLib ou similar reads features via NetTopologySuite converte geometries para PostGIS format valida inserts Units table retornando import summary successes count failures array com error messages per feature, progress tracking via QProgressDialog mostrando percentage imported features periodicamente polling GET /api/jobs/:jobId endpoint para long-running imports com centenas milhares de features evitando timeout HTTP request, error handling mostrando detailed error dialog listando failed features com reasons validation failures CRS mismatch duplicate detection permitindo usuário corrigir source shapefile re-import apenas failed subset, rollback support se import fails midway oferecendo undo option deletando partially imported features via transaction rollback garantindo consistency.

Domain model mapeando shapefile features para CENTRAL Unit entity extraindo attributes via feature.attribute(fieldName) convertendo para types apropriados string para name DateTime para created_at float para area UUID para holder_id se presente, geometry transformation de OGR Geometry para WKT via feature.geometry().asWkt() enviando para backend que converte para PostGIS Geography type com SRID 4326, implementação UC-008 requirements incluindo selecionar shapefile via file browser com validação formato presença companion files, validar geometrias topology CRS attributes antes de import mostrando validation report, mapear atributos shapefile para campos Unit entity via interactive table dropdown matching, preview features em map canvas com styling diferenciado valid invalid permitindo inspeção visual, executar import com progress tracking mostrando successes failures summary, tratar duplicates oferecendo skip overwrite merge options conforme RN-015, relacionamento requirements implementando UC-008 fluxo principal importação bulk dados geoespaciais externos shapefile polygon validation attribute mapping rastreando RF-012 RF-013 importação dados georreferenciados.

---

**Última atualização:** 2026-01-11
