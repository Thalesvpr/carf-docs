Setup Keycloak no GEOGIS requer primeiro instalar python-keycloak library via OSGeo4W Shell Windows executando python -m pip install python-keycloak requests ou terminal Linux macOS com /usr/bin/python3 -m pip install python-keycloak requests usando QGIS Python interpreter path verificar installation abrindo QGIS Python Console digitando import keycloak print(keycloak.__version__) should print version sem errors criar config.py em plugin directory com constants KEYCLOAK_URL = 'http://localhost:8080' KEYCLOAK_REALM = 'carf' KEYCLOAK_CLIENT_ID = 'geogis' KEYCLOAK_CLIENT_SECRET = '' filled later API_URL = 'http://localhost:5000'.

Criar auth_manager.py implementando AuthManager class singleton com _instance = None @classmethod getInstance() returning cached instance __init__() initializing KeycloakOpenID with config values self.access_token = None self.refresh_token = None self.expires_at = None implementar login_service_account() method para client credentials flow executando token = self.keycloak_openid.token(grant_type='client_credentials') catching exceptions storing tokens via QSettings settings = QSettings('CARF', 'GEOGIS') settings.setValue('access_token', token['access_token']) seting self.expires_at = datetime.now() + timedelta(seconds=token['expires_in']) implementar login_user() method para authorization code flow gerando code_verifier com secrets.token_urlsafe(64) calculating code_challenge SHA256 hash base64.urlsafe_b64encode(hashlib.sha256(code_verifier.encode()).digest()).decode().rstrip('=').

Construindo auth_url com f'{KEYCLOAK_URL}/realms/{REALM}/protocol/openid-connect/auth?client_id={CLIENT_ID}&redirect_uri=http://localhost:8888/callback&response_type=code&scope=openid profile email&code_challenge={code_challenge}&code_challenge_method=S256' abrindo browser com webbrowser.open(auth_url) starting local server httpd = HTTPServer(('localhost', 8888), CallbackHandler) httpd.handle_request() blocking até callback received CallbackHandler class extends BaseHTTPRequestHandler implementing do_GET(self) extraindo code with params = parse_qs(urlparse(self.path).query) code = params.get('code', [None])[0] storing globally global auth_code auth_code = code responding self.send_response(200) self.send_header('Content-type', 'text/html') self.end_headers() self.wfile.write(b'Login successful!') após callback exchange code via POST requests.post(f'{KEYCLOAK_URL}/realms/{REALM}/protocol/openid-connect/token', data={'grant_type': 'authorization_code', 'client_id': CLIENT_ID, 'code': code, 'code_verifier': code_verifier, 'redirect_uri': 'http://localhost:8888/callback'}) parsing JSON response storing tokens QSettings.

Implementar getAccessToken() checking expiration refreshing if needed implementar logout() revoking token e clearing QSettings configurar Keycloak client acessando Admin Console http://localhost:8080 com admin/admin selecionando realm carf Clients Create client ID=geogis Save Settings tab configurando Access Type: confidential Service Accounts Enabled: ON if using service account Standard Flow Enabled: ON if using user flow Valid Redirect URIs: http://localhost:8888/callback Web Origins: * Save Credentials tab copiando Secret para config.py KEYCLOAK_CLIENT_SECRET Service Account Roles tab if enabled assigning roles ao service account user testar service account login abrindo QGIS Python Console executando from auth_manager import AuthManager am = AuthManager.getInstance() am.login_service_account() print(am.access_token) should print token testar user login executando am.login_user() should open browser fazer login redirect de volta printing token testar API call import requests r = requests.get(API_URL + '/api/occupations', headers={'Authorization': f'Bearer {am.getAccessToken()}'}) print(r.json()) should return data filtered by tenant RLS.

---

**Última atualização:** 2026-01-15
**Status do arquivo**: Incompleto
Descrição: Falta título H1 na primeira linha.
